# =2073=====================================================
# üß≠ Description: Code_022.1 FINAL 1 (Updated)
#  ‚Ä¢ Full finance UI: day window, edit menu, /prev /next /view, 31-day calendar, reports
#  ‚Ä¢ Per-chat storage: data_<chat_id>.json, data_<chat_id>.csv, csv_meta_<chat_id>.json
#  ‚Ä¢ Backup & restore via Google Drive + backup Telegram channel
#  ‚Ä¢ Anonymous message forwarding between chats (forward_rules, owner-configurable)
#  ‚Ä¢ Finance mode must be enabled per chat via /–ø–æ–µ—Ö–∞–ª–∏
#  ‚Ä¢ Keep-alive, webhook/Flask, daily window scheduler, auto backups
#  ‚Ä¢ This build: 022.1 FINAL 1 ‚Äî –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ –º–µ–Ω—é, –ø–µ—Ä–µ—Å—ã–ª–∫–∞, CSV –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏
# ==========================================================

# ========== SECTION 1 ‚Äî Imports & basic config ==========
import os
import io
import json
import csv
import re
import html
import logging
import threading
import time
from datetime import datetime, timedelta, timezone
from zoneinfo import ZoneInfo

import requests
import telebot
from telebot import types
from flask import Flask, request

# --- Google Drive ---
from googleapiclient.http import MediaFileUpload, MediaIoBaseDownload
from googleapiclient.discovery import build
from google.oauth2 import service_account

# ========== SECTION 2 ‚Äî Environment & globals ==========

BOT_TOKEN = os.getenv("BOT_TOKEN", "").strip()
OWNER_ID = os.getenv("OWNER_ID", "").strip()
BACKUP_CHAT_ID = os.getenv("BACKUP_CHAT_ID", "").strip()
GOOGLE_SERVICE_ACCOUNT_JSON = os.getenv("GOOGLE_SERVICE_ACCOUNT_JSON", "").strip()
GDRIVE_FOLDER_ID = os.getenv("GDRIVE_FOLDER_ID", "").strip()
APP_URL = os.getenv("APP_URL", "").strip()
PORT = int(os.getenv("PORT", "8443"))

if not BOT_TOKEN:
    raise RuntimeError("BOT_TOKEN is not set")

VERSION = "Code_022.1 FINAL 1"

DEFAULT_TZ = "America/Argentina/Buenos_Aires"
KEEP_ALIVE_INTERVAL_SECONDS = 60

DATA_FILE = "data.json"
CSV_FILE = "data.csv"
CSV_META_FILE = "csv_meta.json"

# Global flags (runtime, also duplicated into data["backup_flags"])
backup_flags = {
    "drive": True,
    "channel": True,
}

# logging
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s"
)
logger = logging.getLogger(__name__)

bot = telebot.TeleBot(BOT_TOKEN, parse_mode=None)
app = Flask(__name__)

# main in-memory store
data = {}

# chats where finance mode is enabled
finance_active_chats = set()

# ==========================================================
# SECTION 3 ‚Äî Helpers (time, logging)
# ==========================================================

def log_info(msg: str):
    logger.info(msg)


def log_error(msg: str):
    logger.error(msg)


def get_tz():
    """Return local timezone, with fallback to UTC-3."""
    try:
        return ZoneInfo(DEFAULT_TZ)
    except Exception:
        return timezone(timedelta(hours=-3))


def now_local():
    return datetime.now(get_tz())


def today_key() -> str:
    return now_local().strftime("%Y-%m-%d")


# ==========================================================
# SECTION 4 ‚Äî JSON/CSV helpers
# ==========================================================

def _load_json(path: str, default):
    if not os.path.exists(path):
        return default
    try:
        with open(path, "r", encoding="utf-8") as f:
            return json.load(f)
    except Exception as e:
        log_error(f"JSON load error {path}: {e}")
        return default


def _save_json(path: str, obj):
    try:
        with open(path, "w", encoding="utf-8") as f:
            json.dump(obj, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"JSON save error {path}: {e}")


def _load_csv_meta():
    return _load_json(CSV_META_FILE, {})


def _save_csv_meta(meta: dict):
    try:
        _save_json(CSV_META_FILE, meta)
        log_info("csv_meta.json updated")
    except Exception as e:
        log_error(f"_save_csv_meta: {e}")


def default_data():
    return {
        "overall_balance": 0,
        "records": [],
        "chats": {},
        "active_messages": {},
        "next_id": 1,
        "backup_flags": {"drive": True, "channel": True},
        "finance_active_chats": {},
        "forward_rules": {},
    }


def load_data():
    d = _load_json(DATA_FILE, default_data())
    base = default_data()
    for k, v in base.items():
        if k not in d:
            d[k] = v
    # sync runtime flags from stored flags
    flags = d.get("backup_flags") or {}
    backup_flags["drive"] = bool(flags.get("drive", True))
    backup_flags["channel"] = bool(flags.get("channel", True))
    # restore finance_active_chats set
    fac = d.get("finance_active_chats") or {}
    finance_active_chats.clear()
    for cid, enabled in fac.items():
        if enabled:
            try:
                finance_active_chats.add(int(cid))
            except Exception:
                pass
    return d


def save_data(d):
    # mirror finance_active_chats set into dict
    fac = {}
    for cid in finance_active_chats:
        fac[str(cid)] = True
    d["finance_active_chats"] = fac
    d["backup_flags"] = {
        "drive": bool(backup_flags.get("drive", True)),
        "channel": bool(backup_flags.get("channel", True)),
    }
    _save_json(DATA_FILE, d)


# ==========================================================
# SECTION 5 ‚Äî Per-chat storage helpers
# ==========================================================

def chat_json_file(chat_id: int) -> str:
    return f"data_{chat_id}.json"


def chat_csv_file(chat_id: int) -> str:
    return f"data_{chat_id}.csv"


def chat_meta_file(chat_id: int) -> str:
    return f"csv_meta_{chat_id}.json"


def get_chat_store(chat_id: int) -> dict:
    chats = data.setdefault("chats", {})
    return chats.setdefault(
        str(chat_id),
        {
            "info": {},
            "balance": 0,
            "records": [],
            "daily_records": {},
            "next_id": 1,
            "active_windows": {},
            "edit_wait": None,
            "edit_target": None,
            "current_view_day": today_key(),
        }
    )


def save_chat_json(chat_id: int):
    """Save per-chat JSON, CSV and META for one chat."""
    try:
        store = data.get("chats", {}).get(str(chat_id), {})
        if not store:
            return

        chat_path_json = chat_json_file(chat_id)
        chat_path_csv = chat_csv_file(chat_id)
        chat_path_meta = chat_meta_file(chat_id)

        # ensure files exist
        for p in (chat_path_json, chat_path_csv, chat_path_meta):
            if not os.path.exists(p):
                with open(p, "a", encoding="utf-8"):
                    pass

        payload = {
            "chat_id": chat_id,
            "balance": store.get("balance", 0),
            "records": store.get("records", []),
            "daily_records": store.get("daily_records", {}),
            "next_id": store.get("next_id", 1),
            "info": store.get("info", {}),
        }
        _save_json(chat_path_json, payload)

        with open(chat_path_csv, "w", newline="", encoding="utf-8") as f:
            w = csv.writer(f)
            w.writerow(["chat_id", "ID", "short_id", "timestamp", "amount", "note", "owner", "day_key"])
            for dk, recs in store.get("daily_records", {}).items():
                for r in recs:
                    w.writerow([
                        chat_id,
                        r.get("id"),
                        r.get("short_id"),
                        r.get("timestamp"),
                        r.get("amount"),
                        r.get("note"),
                        r.get("owner"),
                        dk,
                    ])

        meta = {
            "last_saved": now_local().isoformat(timespec="seconds"),
            "record_count": sum(len(v) for v in store.get("daily_records", {}).values()),
        }
        _save_json(chat_path_meta, meta)
        log_info(f"Per-chat files saved for chat {chat_id}")
    except Exception as e:
        log_error(f"save_chat_json({chat_id}): {e}")


# ==========================================================
# SECTION 6 ‚Äî Number formatting & parsing
# ==========================================================

def fmt_num(x: int) -> str:
    return f"{x:,}".replace(",", " ")


num_re = re.compile(r'[+\-]?\s*\d(?:[\d\s\._\'",]*\d)?')


def parse_amount(text: str) -> int:
    """
    Parse a messy human-entered amount into int.
    Supports + / -, spaces, dots, commas as thousand/decimal separators.
    """
    s = text.strip()
    m = num_re.search(s)
    if not m:
        raise ValueError("no number found")

    s = m.group(0).strip()
    negative = s.startswith("-")
    s = s.lstrip("+-").strip()

    s = s.replace(" ", "").replace("'", "").replace("_", "")
    if "," in s and "." in s:
        if s.rfind(",") > s.rfind("."):
            s = s.replace(".", "").replace(",", ".")
        else:
            s = s.replace(",", "")
    elif "," in s and "." not in s:
        s = s.replace(".", "").replace(",", ".")
    else:
        s = s.replace(",", "")

    value = float(s)
    if negative:
        value = -value
    return int(round(value))


# ==========================================================
# SECTION 7 ‚Äî Google Drive helpers
# ==========================================================

def _get_drive_service():
    if not GOOGLE_SERVICE_ACCOUNT_JSON or not GDRIVE_FOLDER_ID:
        return None
    try:
        info = json.loads(GOOGLE_SERVICE_ACCOUNT_JSON)
        creds = service_account.Credentials.from_service_account_info(
            info,
            scopes=["https://www.googleapis.com/auth/drive"]
        )
        service = build("drive", "v3", credentials=creds)
        return service
    except Exception as e:
        log_error(f"Drive service error: {e}")
        return None


def upload_to_gdrive(path: str, mime_type: str = None, description: str | None = None):
    flags = backup_flags or {}
    if not flags.get("drive", True):
        log_info("GDrive backup disabled (drive flag = False).")
        return

    service = _get_drive_service()
    if service is None:
        return

    if not os.path.exists(path):
        log_error(f"upload_to_gdrive: file not found {path}")
        return

    fname = os.path.basename(path)
    file_metadata = {
        "name": fname,
        "parents": [GDRIVE_FOLDER_ID],
        "description": description or "",
    }
    media = MediaFileUpload(path, mimetype=mime_type, resumable=True)

    try:
        existing = service.files().list(
            q=f"name = '{fname}' and '{GDRIVE_FOLDER_ID}' in parents and trashed = false",
            spaces="drive",
            fields="files(id, name)",
        ).execute()
        items = existing.get("files", [])
        if items:
            file_id = items[0]["id"]
            service.files().update(
                fileId=file_id,
                media_body=media,
                body={"description": description or ""},
            ).execute()
            log_info(f"GDrive: updated {fname}, id={file_id}")
        else:
            created = service.files().create(
                body=file_metadata,
                media_body=media,
                fields="id"
            ).execute()
            log_info(f"GDrive: created {fname}, id={created.get('id')}")
    except Exception as e:
        log_error(f"upload_to_gdrive({path}): {e}")


def download_from_gdrive(filename: str, dest_path: str) -> bool:
    service = _get_drive_service()
    if service is None:
        return False
    try:
        res = service.files().list(
            q=f"name = '{filename}' and '{GDRIVE_FOLDER_ID}' in parents and trashed = false",
            spaces="drive",
            fields="files(id, name, mimeType, size)",
        ).execute()
        items = res.get("files", [])
        if not items:
            log_info(f"GDrive: {filename} not found")
            return False
        file_id = items[0]["id"]
        request = service.files().get_media(fileId=file_id)
        fh = io.FileIO(dest_path, "wb")
        downloader = MediaIoBaseDownload(fh, request)
        done = False
        while not done:
            status, done = downloader.next_chunk()
        log_info(f"GDrive: downloaded {filename} -> {dest_path}")
        return True
    except Exception as e:
        log_error(f"download_from_gdrive({filename}): {e}")
        return False


def restore_from_gdrive_if_needed() -> bool:
    """
    If local DATA_FILE/CSV_FILE/CSV_META_FILE are missing,
    try to restore them from Google Drive.
    """
    restored_any = False
    if not os.path.exists(DATA_FILE):
        if download_from_gdrive(os.path.basename(DATA_FILE), DATA_FILE):
            restored_any = True
    if not os.path.exists(CSV_FILE):
        if download_from_gdrive(os.path.basename(CSV_FILE), CSV_FILE):
            restored_any = True
    if not os.path.exists(CSV_META_FILE):
        if download_from_gdrive(os.path.basename(CSV_META_FILE), CSV_META_FILE):
            restored_any = True

    if restored_any:
        log_info("Data restored from Google Drive.")
    else:
        log_info("GDrive restore: nothing to restore.")
    return restored_any
#1Ô∏è‚É£üîü‚è´Ô∏è

#2Ô∏è‚É£üîü‚è¨Ô∏è
# ==========================================================
# SECTION 8 ‚Äî Global CSV export & backup to channel
# ==========================================================

def export_global_csv(d: dict):
    """Legacy global CSV with all chats (for backup channel –∏–ª–∏ /csv_all)."""
    try:
        with open(CSV_FILE, "w", newline="", encoding="utf-8") as f:
            w = csv.writer(f)
            w.writerow(["chat_id", "ID", "short_id", "timestamp", "amount",
                        "note", "owner", "day_key"])
            for cid, cdata in d.get("chats", {}).items():
                for dk, records in cdata.get("daily_records", {}).items():
                    for r in records:
                        w.writerow([
                            cid,
                            r.get("id"),
                            r.get("short_id"),
                            r.get("timestamp"),
                            r.get("amount"),
                            r.get("note"),
                            r.get("owner"),
                            dk,
                        ])
    except Exception as e:
        log_error(f"export_global_csv: {e}")


def send_backup_to_channel_for_file(base_path: str, meta_key_prefix: str):
    """Helper to send or update a file in BACKUP_CHAT_ID with csv_meta tracking."""
    if not BACKUP_CHAT_ID:
        return
    if not os.path.exists(base_path):
        return

    try:
        meta = _load_csv_meta()
        msg_key = f"msg_{meta_key_prefix}"
        ts_key = f"timestamp_{meta_key_prefix}"

        with open(base_path, "rb") as f:
            caption = f"üì¶ {os.path.basename(base_path)} ‚Äî {now_local().strftime('%Y-%m-%d %H:%M')}"

            if meta.get(msg_key):
                try:
                    bot.edit_message_media(
                        chat_id=int(BACKUP_CHAT_ID),
                        message_id=meta[msg_key],
                        media=telebot.types.InputMediaDocument(f, caption=caption),
                    )
                    log_info(f"Channel file updated: {base_path}")
                except Exception as e:
                    log_error(f"edit_message_media {base_path}: {e}")
                    sent = bot.send_document(int(BACKUP_CHAT_ID), f, caption=caption)
                    meta[msg_key] = sent.message_id
            else:
                sent = bot.send_document(int(BACKUP_CHAT_ID), f, caption=caption)
                meta[msg_key] = sent.message_id

        meta[ts_key] = now_local().isoformat(timespec="seconds")
        _save_csv_meta(meta)

    except Exception as e:
        log_error(f"send_backup_to_channel_for_file({base_path}): {e}")


def send_backup_to_channel(chat_id: int):
    """
    Send per-chat JSON/CSV and optionally global CSV to BACKUP_CHAT_ID,
    respecting channel backup flag.
    """
    flags = backup_flags or {}
    if not flags.get("channel", True):
        log_info("Channel backup disabled (channel flag = False).")
        return

    if not BACKUP_CHAT_ID:
        log_info("BACKUP_CHAT_ID not set, skipping backup to channel.")
        return

    try:
        # ensure per-chat files are fresh
        save_chat_json(chat_id)

        # per-chat
        send_backup_to_channel_for_file(chat_json_file(chat_id),
                                        f"json_chat_{chat_id}")
        send_backup_to_channel_for_file(chat_csv_file(chat_id),
                                        f"csv_chat_{chat_id}")

        # optional: global CSV
        export_global_csv(data)
        send_backup_to_channel_for_file(CSV_FILE, "csv_global")

    except Exception as e:
        log_error(f"send_backup_to_channel({chat_id}): {e}")


# ==========================================================
# SECTION 9 ‚Äî Forward rules persistence (owner file)
# ==========================================================

def _owner_data_file() -> str | None:
    if not OWNER_ID:
        return None
    return f"data_{int(OWNER_ID)}.json"


def persist_forward_rules_to_owner():
    """
    Save forward_rules into data_<OWNER_ID>.json only (not global data.json).
    """
    try:
        path = _owner_data_file()
        if not path:
            return

        payload = {}
        if os.path.exists(path):
            payload = _load_json(path, {})
            if not isinstance(payload, dict):
                payload = {}

        payload["forward_rules"] = data.get("forward_rules", {})
        _save_json(path, payload)

        log_info(f"forward_rules persisted to {path}")

    except Exception as e:
        log_error(f"persist_forward_rules_to_owner: {e}")


# ==========================================================
# SECTION 10 ‚Äî –†–∞–±–æ—Ç–∞ —Å forward_rules (–ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏)
# ==========================================================

def resolve_forward_targets(source_chat_id: int) -> list[int]:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤, –∫—É–¥–∞ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.
    forward_rules:
        {
            "123": ["100", "200"],   # –∏–∑ 123 ‚Üí 100 –∏ 200
            "100": ["123"],          # –¥–≤—É—Ö—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ
        }
    """
    fr = data.get("forward_rules", {}) or {}
    out = fr.get(str(source_chat_id), [])
    res = []
    for x in out:
        try:
            res.append(int(x))
        except:
            pass
    return res


def add_forward_link(src_chat_id: int, dst_chat_id: int):
    """–î–æ–±–∞–≤–ª—è–µ—Ç –ø–µ—Ä–µ—Å—ã–ª–∫—É src ‚Üí dst."""
    fr = data.setdefault("forward_rules", {})
    arr = fr.setdefault(str(src_chat_id), [])
    if str(dst_chat_id) not in arr:
        arr.append(str(dst_chat_id))
    persist_forward_rules_to_owner()
    save_data(data)


def remove_forward_link(src_chat_id: int, dst_chat_id: int):
    """–£–¥–∞–ª—è–µ—Ç –ø–µ—Ä–µ—Å—ã–ª–∫—É src ‚Üí dst."""
    fr = data.get("forward_rules", {}) or {}
    arr = fr.get(str(src_chat_id), [])
    if str(dst_chat_id) in arr:
        arr.remove(str(dst_chat_id))
    persist_forward_rules_to_owner()
    save_data(data)


def clear_forward_all():
    """–ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏."""
    data["forward_rules"] = {}
    persist_forward_rules_to_owner()
    save_data(data)

# ==========================================================
# SECTION 11 ‚Äî –ë–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –æ–∫–Ω–æ–º –¥–Ω—è (render)
# ==========================================================

def render_day_window(chat_id: int, day_key: str):
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –æ–∫–Ω–∞ –¥–Ω—è.

    –¢–ó 022.1 FINAL 1:
    ‚Ä¢ –í–º–µ—Å—Ç–æ ¬´–ò—Ç–æ–≥–æ –∑–∞ –¥–µ–Ω—å¬ª –ø–æ–∫–∞–∑—ã–≤–∞–µ–º ¬´–û–°–¢–ê–¢–û–ö¬ª ‚Äî –æ—Å—Ç–∞—Ç–æ–∫ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è –ø–æ —á–∞—Ç—É.
    ‚Ä¢ –í—Å–µ —Ä–∞—Å—á—ë—Ç—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –ø–æ —á–∞—Ç—É.
    """
    store = get_chat_store(chat_id)
    day_recs = store.get("daily_records", {}).get(day_key, [])

    lines = [f"üìÖ <b>{day_key}</b>"]
    day_total = 0

    for r in day_recs:
        amt = r["amount"]
        day_total += amt
        sign = "‚ûï" if amt >= 0 else "‚ûñ"
        lines.append(f"{sign} {fmt_num(amt)} ‚Äî {html.escape(r.get('note', ''))}")

    lines.append("")
    balance = store.get("balance", 0)
    lines.append(f"üí∞ –û–°–¢–ê–¢–û–ö: {fmt_num(balance)}")

    text = "\n".join(lines)
    return text, day_total


# ==========================================================
# SECTION 12 ‚Äî –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã: –≥–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ, –∫–∞–ª–µ–Ω–¥–∞—Ä—å, –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
# ==========================================================

def build_main_keyboard(day_key: str, chat_id=None):
    kb = types.InlineKeyboardMarkup(row_width=2)

    kb.row(
        types.InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å", callback_data=f"d:{day_key}:add"),
        types.InlineKeyboardButton("üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"d:{day_key}:edit_menu")
    )

    kb.row(
        types.InlineKeyboardButton("‚¨ÖÔ∏è –í—á–µ—Ä–∞", callback_data=f"d:{day_key}:prev"),
        types.InlineKeyboardButton("‚û°Ô∏è –ó–∞–≤—Ç—Ä–∞", callback_data=f"d:{day_key}:next")
    )

    # –ö–∞–ª–µ–Ω–¥–∞—Ä—å + –æ—Ç—á—ë—Ç
    kb.row(
        types.InlineKeyboardButton("üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å", callback_data=f"d:{day_key}:calendar"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data=f"d:{day_key}:report")
    )

    # –ö–Ω–æ–ø–∫–∞ "–°–µ–≥–æ–¥–Ω—è", –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å
    if day_key != today_key():
        kb.row(
            types.InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data=f"d:{today_key()}:open")
        )

    # –ò–Ω—Ñ–æ + –æ–±—â–∏–π –∏—Ç–æ–≥
    kb.row(
        types.InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ", callback_data=f"d:{day_key}:info"),
        types.InlineKeyboardButton("üí∞ –û–±—â–∏–π –∏—Ç–æ–≥", callback_data=f"d:{day_key}:total")
    )
    return kb


def build_calendar_keyboard(center_day: datetime, chat_id: int):
    """
    –ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ 31 –¥–µ–Ω—å:
    ‚Ä¢ –¥–Ω–∏, –≥–¥–µ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏, –ø–æ–º–µ—á–∞–µ–º üìù
    ‚Ä¢ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ ¬´–°–µ–≥–æ–¥–Ω—è¬ª –∏ ¬´–ù–∞–∑–∞–¥¬ª
    """
    kb = types.InlineKeyboardMarkup(row_width=4)
    store = get_chat_store(chat_id)
    daily = store.get("daily_records", {}) or {}

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 31 –¥–µ–Ω—å (8 —Å—Ç—Ä–æ–∫ –ø–æ 4 –∫–Ω–æ–ø–∫–∏)
    start_day = center_day - timedelta(days=15)
    for week in range(0, 32, 4):
        row = []
        for d in range(4):
            day = start_day + timedelta(days=week + d)
            key = day.strftime("%Y-%m-%d")
            label = day.strftime("%d.%m")
            if key in daily and daily[key]:
                label += "üìù"
            row.append(types.InlineKeyboardButton(label, callback_data=f"d:{key}:open"))
        kb.row(*row)

    kb.row(
        types.InlineKeyboardButton(
            "‚¨ÖÔ∏è ‚àí31",
            callback_data=f"c:{(center_day - timedelta(days=31)).strftime('%Y-%m-%d')}"
        ),
        types.InlineKeyboardButton(
            "‚û°Ô∏è +31",
            callback_data=f"c:{(center_day + timedelta(days=31)).strftime('%Y-%m-%d')}"
        )
    )

    kb.row(
        types.InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data=f"d:{today_key()}:open")
    )

    # –ù–∞–∑–∞–¥ –≤ –æ—Å–Ω–æ–≤–Ω–æ–µ –æ–∫–Ω–æ —Ç–µ–∫—É—â–µ–≥–æ —Ü–µ–Ω—Ç—Ä–∞
    kb.row(
        types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{center_day.strftime('%Y-%m-%d')}:back_main")
    )

    return kb


def build_edit_menu_keyboard(day_key: str, chat_id=None):
    """
    –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
    –¢–ó:
    ‚Ä¢ ¬´–û–±—â–∏–π CSV¬ª ‚Üí CSV —ç—Ç–æ–≥–æ —á–∞—Ç–∞
    ‚Ä¢ –æ–±—â–∏–π CSV –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π /csv_all (—Å–º. –∏–Ω—Ñ–æ)
    ‚Ä¢ –≤–æ –≤—Å–µ—Ö –º–µ–Ω—é ‚Äî –∫–Ω–æ–ø–∫–∞ ¬´–ù–∞–∑–∞–¥¬ª
    """
    kb = types.InlineKeyboardMarkup(row_width=2)

    kb.row(
        types.InlineKeyboardButton("üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å", callback_data=f"d:{day_key}:edit_list"),
        types.InlineKeyboardButton("üìÇ CSV —ç—Ç–æ–≥–æ —á–∞—Ç–∞", callback_data=f"d:{day_key}:csv_chat")
    )

    kb.row(
        types.InlineKeyboardButton("üìÖ CSV –∑–∞ –¥–µ–Ω—å", callback_data=f"d:{day_key}:csv_day"),
        types.InlineKeyboardButton("‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å", callback_data=f"d:{day_key}:reset")
    )

    # –∫–Ω–æ–ø–∫–∞ ¬´–ü–µ—Ä–µ—Å—ã–ª–∫–∞¬ª ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞
    if OWNER_ID and str(chat_id) == str(OWNER_ID):
        kb.row(
            types.InlineKeyboardButton("üîÅ –ü–µ—Ä–µ—Å—ã–ª–∫–∞", callback_data=f"d:{day_key}:forward_menu")
        )

    kb.row(
        types.InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data=f"d:{today_key()}:open"),
        types.InlineKeyboardButton("üìÜ –í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å", callback_data=f"d:{day_key}:pick_date")
    )

    kb.row(
        types.InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ", callback_data=f"d:{day_key}:info"),
        types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:back_main")
    )
    return kb

# ==========================================================
# SECTION 13 ‚Äî –î–æ–±–∞–≤–ª–µ–Ω–∏–µ, –∏–∑–º–µ–Ω–µ–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
# ==========================================================

def add_record_to_chat(chat_id: int, amount: int, note: str, owner,
                       day_key: str | None = None):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ —á–∞—Ç:
    –æ–±–Ω–æ–≤–ª—è–µ—Ç records, daily_records, CSV, JSON, –±–∞–ª–∞–Ω—Å,
    –¥–µ–ª–∞–µ—Ç –±—ç–∫–∞–ø (Drive+–∫–∞–Ω–∞–ª).

    –¢–ó: –∑–∞–ø–∏—Å—å –∏–¥—ë—Ç –≤ —Ç–æ—Ç –¥–µ–Ω—å, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (day_key).
    """
    store = get_chat_store(chat_id)

    if day_key is None:
        day_key = today_key()

    rid = store.get("next_id", 1)
    rec = {
        "id": rid,
        "short_id": f"R{rid}",
        "timestamp": now_local().isoformat(timespec="seconds"),
        "amount": amount,
        "note": note,
        "owner": owner,
    }

    # –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ (–¥–ª—è –æ–±—â–µ–≥–æ CSV)
    data.setdefault("records", []).append(rec)

    # per-chat
    store.setdefault("records", []).append(rec)
    store.setdefault("daily_records", {}).setdefault(day_key, []).append(rec)

    # –ø–µ—Ä–µ—Å—á—ë—Ç –±–∞–ª–∞–Ω—Å–æ–≤
    store["balance"] = store.get("balance", 0) + amount
    data["overall_balance"] = data.get("overall_balance", 0) + amount
    store["next_id"] = rid + 1

    save_data(data)
    save_chat_json(chat_id)
    send_backup_to_channel(chat_id)


def update_record_in_chat(chat_id: int, rid: int, new_amount: int,
                          new_note: str, user=None):
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å.
    """
    store = get_chat_store(chat_id)
    found = None

    # –æ–±–Ω–æ–≤–ª—è–µ–º –≤ store["records"]
    for r in store.get("records", []):
        if r["id"] == rid:
            old_amount = r["amount"]
            r["amount"] = new_amount
            r["note"] = new_note
            found = r
            break

    if not found:
        return

    # –æ–±–Ω–æ–≤–ª—è–µ–º –≤–Ω—É—Ç—Ä–∏ daily_records
    for day_recs in store.get("daily_records", {}).values():
        for r in day_recs:
            if r["id"] == rid:
                r.update(found)

    # –ø–µ—Ä–µ—Å—á—ë—Ç –±–∞–ª–∞–Ω—Å–∞ –ø–æ —á–∞—Ç—É
    store["balance"] = sum(x["amount"] for x in store.get("records", []))

    # –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫
    data["records"] = [
        x if x["id"] != rid else found
        for x in data.get("records", [])
    ]
    data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))

    save_data(data)
    save_chat_json(chat_id)
    send_backup_to_channel(chat_id)


def delete_record_in_chat(chat_id: int, rid: int, user=None):
    """
    –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ + –ø–µ—Ä–µ—Å—á—ë—Ç –±–∞–ª–∞–Ω—Å–æ–≤ + –±—ç–∫–∞–ø.
    """
    store = get_chat_store(chat_id)

    before = len(store.get("records", []))
    store["records"] = [r for r in store.get("records", []) if r["id"] != rid]

    # —á–∏—Å—Ç–∏–º daily_records
    for dk, arr in list(store.get("daily_records", {}).items()):
        new_arr = [r for r in arr if r["id"] != rid]
        if new_arr:
            store["daily_records"][dk] = new_arr
        else:
            del store["daily_records"][dk]

    after = len(store.get("records", []))
    if before == after:
        return

    # –ø–µ—Ä–µ—Å—á—ë—Ç –±–∞–ª–∞–Ω—Å–∞
    store["balance"] = sum(x["amount"] for x in store.get("records", []))

    # –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫
    data["records"] = [x for x in data.get("records", []) if x["id"] != rid]
    data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))

    save_data(data)
    save_chat_json(chat_id)
    send_backup_to_channel(chat_id)


def reset_chat_data(chat_id: int):
    """
    –ü–æ–ª–Ω–æ–µ –æ–±–Ω—É–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –û–î–ù–û–ì–û —á–∞—Ç–∞.
    –¢–ó: —Å—Ç—Ä–æ–≥–æ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ, –Ω–∏–∫–∞–∫–∏–µ –¥—Ä—É–≥–∏–µ —á–∞—Ç—ã –Ω–µ —Ç—Ä–æ–≥–∞–µ–º.
    """
    chats = data.setdefault("chats", {})
    if str(chat_id) in chats:
        del chats[str(chat_id)]

    for p in (chat_json_file(chat_id),
              chat_csv_file(chat_id),
              chat_meta_file(chat_id)):
        try:
            os.remove(p)
        except FileNotFoundError:
            pass

    save_data(data)
    export_global_csv(data)
    send_backup_to_channel(chat_id)


# ==========================================================
# SECTION 14 ‚Äî –ê–∫—Ç–∏–≤–Ω–æ–µ –æ–∫–Ω–æ (active window tracking)
# ==========================================================

def get_or_create_active_windows(chat_id: int) -> dict:
    return data.setdefault("active_messages", {}).setdefault(str(chat_id), {})


def set_active_window_id(chat_id: int, day_key: str, message_id: int):
    active = get_or_create_active_windows(chat_id)
    active[day_key] = message_id
    save_data(data)


def get_active_window_id(chat_id: int, day_key: str):
    return get_or_create_active_windows(chat_id).get(day_key)


# ==========================================================
# SECTION 15 ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º —Ä–µ–∂–∏–º–æ–º
# ==========================================================

def is_finance_mode(chat_id: int) -> bool:
    return chat_id in finance_active_chats


def set_finance_mode(chat_id: int, enabled: bool):
    if enabled:
        finance_active_chats.add(chat_id)
    else:
        finance_active_chats.discard(chat_id)


def require_finance(chat_id: int) -> bool:
    """
    –ï—Å–ª–∏ —Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω ‚Äî –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º /–ø–æ–µ—Ö–∞–ª–∏.
    """
    if not is_finance_mode(chat_id):
        send_info(chat_id, "‚öôÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω.\n–ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –∫–æ–º–∞–Ω–¥–æ–π /–ø–æ–µ—Ö–∞–ª–∏")
        return False
    return True

#5Ô∏è‚É£üîü
# ==========================================================
# SECTION 16 ‚Äî Callback handler
# ==========================================================

@bot.callback_query_handler(func=lambda c: True)
def on_callback(call):
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö callback_data.
    –§–æ—Ä–º–∞—Ç callback_data:
        d:<day_key>:<cmd>
        c:<center_day>
    """
    try:
        data_str = call.data or ""
        chat_id = call.message.chat.id

        # --- –∫–∞–ª–µ–Ω–¥–∞—Ä—å (c:YYYY-MM-DD)
        if data_str.startswith("c:"):
            center = data_str[2:]
            try:
                center_dt = datetime.strptime(center, "%Y-%m-%d")
            except ValueError:
                return
            kb = build_calendar_keyboard(center_dt, chat_id)
            try:
                bot.edit_message_reply_markup(
                    chat_id=chat_id,
                    message_id=call.message.message_id,
                    reply_markup=kb
                )
            except Exception:
                pass
            return

        # --- d:<day_key>:<cmd>
        if not data_str.startswith("d:"):
            return

        _, day_key, cmd = data_str.split(":", 2)
        store = get_chat_store(chat_id)

        # ==========================
        # –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–Ω—è–º / –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        # ==========================

        if cmd == "open":
            txt, _ = render_day_window(chat_id, day_key)
            kb = build_main_keyboard(day_key, chat_id)
            bot.edit_message_text(
                txt,
                chat_id=chat_id,
                message_id=call.message.message_id,
                reply_markup=kb,
                parse_mode="HTML"
            )
            set_active_window_id(chat_id, day_key, call.message.message_id)
            return

        if cmd == "prev":
            d = datetime.strptime(day_key, "%Y-%m-%d") - timedelta(days=1)
            new_day = d.strftime("%Y-%m-%d")
            txt, _ = render_day_window(chat_id, new_day)
            kb = build_main_keyboard(new_day, chat_id)
            bot.edit_message_text(
                txt,
                chat_id=chat_id,
                message_id=call.message.message_id,
                reply_markup=kb,
                parse_mode="HTML"
            )
            set_active_window_id(chat_id, new_day, call.message.message_id)
            return

        if cmd == "next":
            d = datetime.strptime(day_key, "%Y-%m-%d") + timedelta(days=1)
            new_day = d.strftime("%Y-%m-%d")
            txt, _ = render_day_window(chat_id, new_day)
            kb = build_main_keyboard(new_day, chat_id)
            bot.edit_message_text(
                txt,
                chat_id=chat_id,
                message_id=call.message.message_id,
                reply_markup=kb,
                parse_mode="HTML"
            )
            set_active_window_id(chat_id, new_day, call.message.message_id)
            return

        if cmd == "calendar":
            try:
                center = datetime.strptime(day_key, "%Y-%m-%d")
            except ValueError:
                center = now_local()
            kb = build_calendar_keyboard(center, chat_id)
            bot.edit_message_reply_markup(
                chat_id=chat_id,
                message_id=call.message.message_id,
                reply_markup=kb
            )
            return

        # --------------------------
        # üìä –û—Ç—á—ë—Ç
        # --------------------------
        if cmd == "report":
            lines = ["üìä –û—Ç—á—ë—Ç:"]
            for dk, recs in sorted(store.get("daily_records", {}).items()):
                day_sum = sum(r["amount"] for r in recs)
                lines.append(f"{dk}: {fmt_num(day_sum)}")
            bot.send_message(chat_id, "\n".join(lines))
            return

        # --------------------------
        # üí∞ –û–±—â–∏–π –∏—Ç–æ–≥
        # --------------------------
        if cmd == "total":
            chat_balance = store.get("balance", 0)
            overall = data.get("overall_balance", 0)

            text = (
                "üí∞ <b>–û–±—â–∏–π –∏—Ç–æ–≥</b>\n\n"
                f"‚Ä¢ –ü–æ —ç—Ç–æ–º—É —á–∞—Ç—É: <b>{fmt_num(chat_balance)}</b>\n"
                f"‚Ä¢ –ü–æ –≤—Å–µ–º —á–∞—Ç–∞–º: <b>{fmt_num(overall)}</b>"
            )
            try:
                bot.answer_callback_query(call.id)
            except Exception:
                pass
            bot.send_message(chat_id, text, parse_mode="HTML")
            return

        # ==========================
        # –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        # ==========================

        if cmd == "edit_menu":
            kb = build_edit_menu_keyboard(day_key, chat_id)
            bot.edit_message_reply_markup(
                chat_id=chat_id,
                message_id=call.message.message_id,
                reply_markup=kb
            )
            return

        if cmd == "back_main":
            txt, _ = render_day_window(chat_id, day_key)
            kb = build_main_keyboard(day_key, chat_id)
            bot.edit_message_text(
                txt,
                chat_id=chat_id,
                message_id=call.message.message_id,
                reply_markup=kb,
                parse_mode="HTML"
            )
            return

        if cmd == "info":
            info_text = (
                f"‚ÑπÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION}\n\n"
                "–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
                "/–ø–æ–µ—Ö–∞–ª–∏ ‚Äî –≤–∫–ª—é—á–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –≤ —á–∞—Ç–µ\n"
                "/start ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è\n"
                "/view YYYY-MM-DD ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –¥–µ–Ω—å\n"
                "/prev /next ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–Ω—è–º\n"
                "/balance ‚Äî —Ç–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ —á–∞—Ç—É\n"
                "/report ‚Äî –∫—Ä–∞—Ç–∫–∏–π –æ—Ç—á—ë—Ç –ø–æ –¥–Ω—è–º\n"
                "/csv ‚Äî CSV —ç—Ç–æ–≥–æ —á–∞—Ç–∞\n"
                "/csv_all ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–π CSV –ø–æ –≤—Å–µ–º —á–∞—Ç–∞–º (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü)\n"
                "/json ‚Äî –≤—ã–≥—Ä—É–∑–∫–∞ JSON —ç—Ç–æ–≥–æ —á–∞—Ç–∞\n"
                "/reset –∏–ª–∏ /–æ–±–Ω—É–ª–∏—Ç—å ‚Äî –æ–±–Ω—É–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞ (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)\n"
                "/stopforward ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∏—Ç—å –ø–µ—Ä–µ—Å—ã–ª–∫—É\n"
                "/ping ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n"
                "/backup_gdrive_on / _off ‚Äî –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å GDrive\n"
                "/backup_channel_on / _off ‚Äî –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –±—ç–∫–∞–ø –≤ –∫–∞–Ω–∞–ª\n"
                "/help ‚Äî —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n"
                "–í –º–µ–Ω—é ¬´–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å¬ª –¥–æ—Å—Ç—É–ø–Ω—ã:\n"
                "‚Ä¢ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π (‚úèÔ∏è / ‚ùå)\n"
                "‚Ä¢ CSV —ç—Ç–æ–≥–æ —á–∞—Ç–∞\n"
                "‚Ä¢ –û–±–Ω—É–ª–µ–Ω–∏–µ —á–∞—Ç–∞\n"
                "‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞)\n"
            )
            bot.send_message(chat_id, info_text)
            return

        # ==========================
        # CSV / –æ—Ç—á—ë—Ç—ã
        # ==========================

        if cmd == "csv_chat":
            export_chat_csv_for_callback(chat_id)
            return

        if cmd == "csv_day":
            cmd_csv_day(chat_id, day_key)
            return

        # ==========================
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
        # ==========================

        if cmd == "add":
            if day_key == today_key():
                msg_txt = "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –Ω–∞–ø—Ä–∏–º–µ—Ä: +500 –û–±–µ–¥"
            else:
                msg_txt = "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, —ç—Ç–æ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å"
            bot.send_message(chat_id, msg_txt)
            store["edit_wait"] = {"type": "add", "day_key": day_key}
            save_data(data)
            return

        # ==========================
        # –°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        # ==========================

        if cmd == "edit_list":
            day_recs = store.get("daily_records", {}).get(day_key, [])
            if not day_recs:
                bot.send_message(chat_id, "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.")
                return

            kb2 = types.InlineKeyboardMarkup()

            for r in day_recs:
                lbl = f"{r['short_id']}: {fmt_num(r['amount'])} ‚Äî {r.get('note', '')}"
                rid = r["id"]
                # –í–∞—Ä–∏–∞–Ω—Ç A: –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ + ‚úèÔ∏è + ‚ùå
                kb2.row(
                    types.InlineKeyboardButton(
                        lbl,
                        callback_data=f"d:{day_key}:show_rec_{rid}"
                    ),
                    types.InlineKeyboardButton(
                        "‚úèÔ∏è",
                        callback_data=f"d:{day_key}:edit_rec_{rid}"
                    ),
                    types.InlineKeyboardButton(
                        "‚ùå",
                        callback_data=f"d:{day_key}:del_rec_{rid}"
                    ),
                )

            # –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            kb2.row(
                types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥",
                                           callback_data=f"d:{day_key}:edit_menu")
            )

            bot.send_message(chat_id, "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å:", reply_markup=kb2)
            return

        # ==========================
        # –ü–æ–∫–∞–∑ –∑–∞–ø–∏—Å–∏ (–ø—Ä–æ—Å—Ç–æ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ)
        # ==========================
        if cmd.startswith("show_rec_"):
            try:
                rid = int(cmd.split("_")[-1])
            except Exception:
                return
            try:
                bot.answer_callback_query(call.id, f"–ó–∞–ø–∏—Å—å R{rid}")
            except Exception:
                pass
            return

        # ==========================
        # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏
        # ==========================

        if cmd.startswith("edit_rec_"):
            rid = int(cmd.split("_")[-1])
            store["edit_wait"] = {"type": "edit",
                                  "day_key": day_key,
                                  "rid": rid}
            save_data(data)
            bot.send_message(chat_id, f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—É–º–º—É –∏ —Ç–µ–∫—Å—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏ R{rid}:")
            return

        # ==========================
        # –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ)
        # ==========================

        if cmd.startswith("del_rec_"):
            rid = int(cmd.split("_")[-1])
            store["edit_wait"] = {"type": "del_confirm",
                                  "day_key": day_key,
                                  "rid": rid}
            save_data(data)
            bot.send_message(chat_id,
                             f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å R{rid}? –ù–∞–ø–∏—à–∏—Ç–µ –î–ê.")
            return

        # ==========================
        # –ü–µ—Ä–µ—Å—ã–ª–∫–∞ ‚Äî –≤–µ—Ä—Ö–Ω–µ–µ –º–µ–Ω—é (–¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞)
        # ==========================

        if cmd == "forward_menu":
            if not OWNER_ID or str(chat_id) != str(OWNER_ID):
                bot.send_message(chat_id, "–ü–µ—Ä–µ—Å—ã–ª–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É.")
                return

            fr = data.get("forward_rules", {}) or {}
            chats = data.get("chats", {})

            kb = types.InlineKeyboardMarkup()
            kb.row(
                types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥",
                                           callback_data=f"d:{day_key}:edit_menu")
            )

            for cid_str, cstore in chats.items():
                try:
                    cid = int(cid_str)
                except Exception:
                    continue

                # –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∑–¥–µ—Å—å –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
                if OWNER_ID and cid_str == str(OWNER_ID):
                    continue

                info = cstore.get("info", {}) or {}
                title = info.get("title") or info.get("username") or f"–ß–∞—Ç {cid_str}"
                label = f"{title} ({cid_str})"

                kb.row(
                    types.InlineKeyboardButton(
                        label,
                        callback_data=f"d:{day_key}:fw_cfg_{cid}"
                    )
                )

            bot.send_message(chat_id,
                             "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ—Å—ã–ª–∫–∏:",
                             reply_markup=kb)
            return

#6Ô∏è‚É£üîü
        # ==========================================================
        # –ü–µ—Ä–µ—Å—ã–ª–∫–∞ ‚Äî —ç–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞
        # ==========================================================

        if cmd.startswith("fw_cfg_"):
            """
            –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —Å –¥—Ä—É–≥–∏–º —á–∞—Ç–æ–º:

            –¢–ó:
            ‚Ä¢ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º:
                 ‚û°Ô∏è ‚Äî –ø–µ—Ä–µ—Å—ã–ª–∫–∞ OWNER ‚Üí —ç—Ç–æ—Ç —á–∞—Ç
                 ‚ÜîÔ∏è ‚Äî –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è –ø–µ—Ä–µ—Å—ã–ª–∫–∞
                 ‚¨ÖÔ∏è ‚Äî —á–∞—Ç ‚Üí OWNER
            ‚Ä¢ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–µ–ª–∫–∞ –ø–æ–ª—É—á–∞–µ—Ç ¬´‚úÖ¬ª
            """

            if not OWNER_ID or str(chat_id) != str(OWNER_ID):
                bot.send_message(chat_id, "–ü–µ—Ä–µ—Å—ã–ª–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É.")
                return

            try:
                target_id = int(cmd.split("_")[-1])
            except Exception:
                return

            fr = data.get("forward_rules", {}) or {}

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–∂–∏–º—ã
            owner = int(OWNER_ID)
            one_way_to = str(owner) in fr.get(str(target_id), [])     # —á–∞—Ç ‚Üí owner
            one_way_from = str(target_id) in fr.get(str(owner), [])   # owner ‚Üí —á–∞—Ç

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–∞–ª–æ—á–∫–∏
            arrow_left = "‚¨ÖÔ∏è" + ("‚úÖ" if one_way_to else "")
            arrow_right = "‚û°Ô∏è" + ("‚úÖ" if one_way_from else "")
            arrow_both = "‚ÜîÔ∏è" + ("‚úÖ" if (one_way_to and one_way_from) else "")

            kb = types.InlineKeyboardMarkup(row_width=3)

            kb.row(
                types.InlineKeyboardButton(
                    arrow_left,
                    callback_data=f"d:{day_key}:fw_left_{target_id}"
                ),
                types.InlineKeyboardButton(
                    arrow_both,
                    callback_data=f"d:{day_key}:fw_both_{target_id}"
                ),
                types.InlineKeyboardButton(
                    arrow_right,
                    callback_data=f"d:{day_key}:fw_right_{target_id}"
                ),
            )

            # –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
            kb.row(
                types.InlineKeyboardButton(
                    "üîô –ù–∞–∑–∞–¥",
                    callback_data=f"d:{day_key}:forward_menu"
                )
            )

            # –ü–æ–ª—É—á–∞–µ–º –∏–º—è —á–∞—Ç–∞
            info = get_chat_store(target_id).get("info", {})
            title = info.get("title") or info.get("username") or f"–ß–∞—Ç {target_id}"

            bot.send_message(
                chat_id,
                f"–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –¥–ª—è:\n<b>{title}</b> ({target_id})",
                parse_mode="HTML",
                reply_markup=kb
            )
            return


        # ==========================================================
        # –†–µ–∂–∏–º—ã –ø–µ—Ä–µ—Å—ã–ª–∫–∏ ‚Äî –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–æ–∫
        # ==========================================================

        # –ß–ê–¢ ‚Üí OWNER
        if cmd.startswith("fw_left_"):
            if not OWNER_ID or str(chat_id) != str(OWNER_ID):
                return
            target = int(cmd.split("_")[-1])

            # –≤–∫–ª—é—á–∞–µ–º target ‚Üí owner
            add_forward_link(target, int(OWNER_ID))
            # –≤—ã–∫–ª—é—á–∞–µ–º owner ‚Üí target
            remove_forward_link(int(OWNER_ID), target)

            # –æ–±–Ω–æ–≤–ª—è–µ–º —ç–∫—Ä–∞–Ω
            bot.answer_callback_query(call.id, "–†–µ–∂–∏–º: —á–∞—Ç ‚Üí –≤–ª–∞–¥–µ–ª–µ—Ü")
            bot.delete_message(chat_id, call.message.message_id)
            bot.process_new_callback_query(
                types.CallbackQuery(
                    id=call.id,
                    from_user=call.from_user,
                    chat_instance="",
                    data=f"d:{day_key}:fw_cfg_{target}",
                    message=None
                )
            )
            return

        # –î–í–£–°–¢–û–†–û–ù–ù–Ø–Ø –ü–ï–†–ï–°–´–õ–ö–ê
        if cmd.startswith("fw_both_"):
            if not OWNER_ID or str(chat_id) != str(OWNER_ID):
                return
            target = int(cmd.split("_")[-1])

            # owner ‚Üí target
            add_forward_link(int(OWNER_ID), target)
            # target ‚Üí owner
            add_forward_link(target, int(OWNER_ID))

            bot.answer_callback_query(call.id, "–†–µ–∂–∏–º: –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è –ø–µ—Ä–µ—Å—ã–ª–∫–∞")
            bot.delete_message(chat_id, call.message.message_id)
            bot.process_new_callback_query(
                types.CallbackQuery(
                    id=call.id,
                    from_user=call.from_user,
                    chat_instance="",
                    data=f"d:{day_key}:fw_cfg_{target}",
                    message=None
                )
            )
            return

        # –í–õ–ê–î–ï–õ–ï–¶ ‚Üí –ß–ê–¢
        if cmd.startswith("fw_right_"):
            if not OWNER_ID or str(chat_id) != str(OWNER_ID):
                return
            target = int(cmd.split("_")[-1])

            # owner ‚Üí target
            add_forward_link(int(OWNER_ID), target)
            # –≤—ã–∫–ª—é—á–∞–µ–º target ‚Üí owner
            remove_forward_link(target, int(OWNER_ID))

            bot.answer_callback_query(call.id, "–†–µ–∂–∏–º: –≤–ª–∞–¥–µ–ª–µ—Ü ‚Üí —á–∞—Ç")
            bot.delete_message(chat_id, call.message.message_id)
            bot.process_new_callback_query(
                types.CallbackQuery(
                    id=call.id,
                    from_user=call.from_user,
                    chat_instance="",
                    #chat_instance="",
                    data=f"d:{day_key}:fw_cfg_{target}",
                    message=None
                )
            )
            return

    except Exception as e:
        log_error(f"on_callback error: {e}")

#7Ô∏è‚É£üîü
# ==========================================================
# SECTION 17 ‚Äî TEXT HANDLER (—Ñ–∏–Ω–∞–Ω—Å—ã + –ø–µ—Ä–µ—Å—ã–ª–∫–∞ + —É–¥–∞–ª–µ–Ω–∏–µ)
# ==========================================================
@bot.message_handler(content_types=["text"])
def handle_text(msg):

    chat_id = msg.chat.id
    text = (msg.text or "").strip()
    store = get_chat_store(chat_id)

    try:
        # ==========================
        # 1) –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤ (–∞–Ω–æ–Ω–∏–º–Ω–æ)
        # ==========================
        if str(chat_id) != str(OWNER_ID):
            targets = resolve_forward_targets(chat_id)
            if targets:
                for dst in targets:
                    try:
                        bot.copy_message(dst, chat_id, msg.message_id)
                    except Exception:
                        pass

        # ==========================================================
        # 2) edit_wait ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ
        # ==========================================================
        wait = store.get("edit_wait")

        if wait:

            # ----- –£–î–ê–õ–ï–ù–ò–ï -----
            if wait.get("type") == "del_confirm":
                rid = wait.get("rid")
                day_key = wait.get("day_key")

                if text.upper() == "–î–ê":
                    delete_record_in_chat(chat_id, rid)
                    store["edit_wait"] = None
                    save_data(data)

                    txt = render_day_window(chat_id, day_key)
                    kb = build_main_keyboard(day_key, chat_id)
                    bot.send_message(chat_id, "üóë –ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞.")
                    bot.send_message(chat_id, txt, reply_markup=kb, parse_mode="HTML")
                else:
                    bot.send_message(chat_id, "‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
                    store["edit_wait"] = None
                return

            # ----- –î–û–ë–ê–í–õ–ï–ù–ò–ï -----
            if wait.get("type") == "add":
                day_key = wait.get("day_key")

                try:
                    parts = text.split(" ", 1)
                    amount = parse_amount(parts[0])
                    note = parts[1] if len(parts) > 1 else ""
                except Exception:
                    bot.send_message(chat_id, "‚ùå –§–æ—Ä–º–∞—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π. –ü—Ä–∏–º–µ—Ä: +500 –û–±–µ–¥")
                    return

                add_record_to_chat(chat_id, amount, note, owner=msg.from_user.id, day_key=day_key)
                store["edit_wait"] = None
                save_data(data)

                txt = render_day_window(chat_id, day_key)
                kb = build_main_keyboard(day_key, chat_id)
                bot.send_message(chat_id, "–ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞.")
                bot.send_message(chat_id, txt, reply_markup=kb, parse_mode="HTML")
                return

            # ----- –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï -----
            if wait.get("type") == "edit":
                rid = wait.get("rid")
                day_key = wait.get("day_key")

                try:
                    parts = text.split(" ", 1)
                    amount = parse_amount(parts[0])
                    note = parts[1] if len(parts) > 1 else ""
                except Exception:
                    bot.send_message(chat_id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü—Ä–∏–º–µ—Ä: +500 –¢–∞–∫—Å–∏")
                    return

                update_record_in_chat(chat_id, rid, amount, note, user=msg.from_user.id)
                store["edit_wait"] = None
                save_data(data)

                txt = render_day_window(chat_id, day_key)
                kb = build_main_keyboard(day_key, chat_id)
                bot.send_message(chat_id, "–ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞.")
                bot.send_message(chat_id, txt, reply_markup=kb, parse_mode="HTML")
                return

        # ==========================================================
        # 3) –û–±–Ω—É–ª–µ–Ω–∏–µ —á–∞—Ç–∞ ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ¬´–î–ê¬ª
        # ==========================================================
        if text.upper() == "–î–ê" and store.get("pending_reset"):
            store["pending_reset"] = False

            try:
                reset_chat_data(chat_id)
            except Exception as e:
                log_error(f"reset_chat_data error: {e}")

                # fallback –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ—Ç:
                data["chats"][str(chat_id)] = default_chat_store()

            save_data(data)
            bot.send_message(chat_id, "‚ôªÔ∏è –î–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞ –æ–±–Ω—É–ª–µ–Ω—ã.")

            day_key = today_key()
            txt = render_day_window(chat_id, day_key)
            kb = build_main_keyboard(day_key, chat_id)
            bot.send_message(chat_id, txt, reply_markup=kb, parse_mode="HTML")
            return

        # ==========================================================
        # 4) –ö–æ–º–∞–Ω–¥–∞ /–æ–±–Ω—É–ª–∏—Ç—å
        # ==========================================================
        if text.lower() == "–æ–±–Ω—É–ª–∏—Ç—å":
            store["pending_reset"] = True
            save_data(data)
            bot.send_message(
                chat_id,
                "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞?\n–ù–∞–ø–∏—à–∏—Ç–µ –î–ê –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è."
            )
            return

    except Exception as e:
        log_error(f"handle_text error: {e}")

# ==========================================================
# SECTION 18 ‚Äî MEDIA HANDLER (–ø–µ—Ä–µ—Å—ã–ª–∫–∞ –≤—Å–µ—Ö –≤–ª–æ–∂–µ–Ω–∏–π)
# ==========================================================

@bot.message_handler(
    content_types=[
        "photo", "audio", "document", "video", "voice",
        "video_note", "sticker", "animation"
    ]
)
def handle_media_forward(msg):
    """
    –ü–µ—Ä–µ—Å—ã–ª–∫–∞ –í–°–ï–• —Ç–∏–ø–æ–≤ –≤–ª–æ–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ copy_message.
    –ê–Ω–æ–Ω–∏–º–Ω–æ. –§–∏–Ω–∞–Ω—Å–æ–≤—É—é –ª–æ–≥–∏–∫—É –Ω–µ —Ç—Ä–æ–≥–∞–µ–º.
    """
    try:
        chat_id = msg.chat.id
        if str(chat_id) == str(OWNER_ID):
            return

        targets = resolve_forward_targets(chat_id)
        if not targets:
            return

        for dst in targets:
            try:
                bot.copy_message(dst, chat_id, msg.message_id)
            except Exception:
                pass

    except Exception as e:
        log_error(f"handle_media_forward: {e}")


# ==========================================================
# SECTION 19 ‚Äî START, /–ø–æ–µ—Ö–∞–ª–∏, /reset, /stopforward, /help
# ==========================================================

@bot.message_handler(commands=["start"])
def handle_start(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)

    store["current_view_day"] = today_key()
    save_data(data)

    txt, _ = render_day_window(chat_id, today_key())
    kb = build_main_keyboard(today_key(), chat_id)
    bot.send_message(chat_id, txt, reply_markup=kb, parse_mode="HTML")


@bot.message_handler(commands=["–ø–æ–µ—Ö–∞–ª–∏", "poehali"])
def handle_poehali(msg):
    chat_id = msg.chat.id
    set_finance_mode(chat_id, True)

    bot.send_message(chat_id, "üöÄ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.")
    txt, _ = render_day_window(chat_id, today_key())
    kb = build_main_keyboard(today_key(), chat_id)
    bot.send_message(chat_id, txt, reply_markup=kb, parse_mode="HTML")


@bot.message_handler(commands=["reset", "–æ–±–Ω—É–ª–∏—Ç—å"])
def handle_reset(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)

    store["pending_reset"] = True
    save_data(data)

    bot.send_message(chat_id,
                     "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞?\n"
                     "–ù–∞–ø–∏—à–∏—Ç–µ –î–ê.")


@bot.message_handler(commands=["stopforward"])
def handle_stopforward(msg):
    if not OWNER_ID or str(msg.chat.id) != str(OWNER_ID):
        bot.send_message(msg.chat.id,
                         "–ö–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É.")
        return

    clear_forward_all()
    bot.send_message(msg.chat.id, "üîÅ –í—Å–µ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã.")


@bot.message_handler(commands=["help", "info"])
def handle_help(msg):
    chat_id = msg.chat.id
    info_text = (
        f"‚ÑπÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION}\n\n"
        "–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/–ø–æ–µ—Ö–∞–ª–∏ ‚Äî –≤–∫–ª—é—á–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –≤ —á–∞—Ç–µ\n"
        "/start ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è\n"
        "/view YYYY-MM-DD ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –¥–µ–Ω—å\n"
        "/prev /next ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–Ω—è–º\n"
        "/balance ‚Äî —Ç–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ —á–∞—Ç—É\n"
        "/report ‚Äî –∫—Ä–∞—Ç–∫–∏–π –æ—Ç—á—ë—Ç –ø–æ –¥–Ω—è–º\n"
        "/csv ‚Äî CSV —ç—Ç–æ–≥–æ —á–∞—Ç–∞\n"
        "/csv_all ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–π CSV –ø–æ –≤—Å–µ–º —á–∞—Ç–∞–º (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü)\n"
        "/json ‚Äî –≤—ã–≥—Ä—É–∑–∫–∞ JSON —ç—Ç–æ–≥–æ —á–∞—Ç–∞\n"
        "/reset –∏–ª–∏ /–æ–±–Ω—É–ª–∏—Ç—å ‚Äî –æ–±–Ω—É–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞ (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)\n"
        "/stopforward ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∏—Ç—å –ø–µ—Ä–µ—Å—ã–ª–∫—É\n"
        "/ping ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n"
        "/backup_gdrive_on / _off ‚Äî –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å GDrive\n"
        "/backup_channel_on / _off ‚Äî –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –±—ç–∫–∞–ø –≤ –∫–∞–Ω–∞–ª\n"
    )
    bot.send_message(chat_id, info_text)

#8Ô∏è‚É£üîü
# ==========================================================
# SECTION 20 ‚Äî /ping, /view, /prev, /next, /balance, /report
# ==========================================================

@bot.message_handler(commands=["ping"])
def handle_ping(msg):
    bot.send_message(msg.chat.id, "PONG üü¢ –ë–æ—Ç –Ω–∞ —Å–≤—è–∑–∏")


@bot.message_handler(commands=["view"])
def handle_view(msg):
    chat_id = msg.chat.id
    if not require_finance(chat_id):
        return

    parts = (msg.text or "").split()
    if len(parts) < 2:
        bot.send_message(chat_id, "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /view YYYY-MM-DD")
        return

    day_key = parts[1]
    try:
        datetime.strptime(day_key, "%Y-%m-%d")
    except ValueError:
        bot.send_message(chat_id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ü—Ä–∏–º–µ—Ä: 2025-01-31")
        return

    store = get_chat_store(chat_id)
    store["current_view_day"] = day_key
    save_data(data)

    txt, _ = render_day_window(chat_id, day_key)
    kb = build_main_keyboard(day_key, chat_id)
    bot.send_message(chat_id, txt, reply_markup=kb, parse_mode="HTML")


@bot.message_handler(commands=["prev"])
def handle_prev(msg):
    chat_id = msg.chat.id
    if not require_finance(chat_id):
        return

    store = get_chat_store(chat_id)
    cur = store.get("current_view_day") or today_key()
    try:
        d = datetime.strptime(cur, "%Y-%m-%d") - timedelta(days=1)
    except ValueError:
        d = datetime.strptime(today_key(), "%Y-%m-%d") - timedelta(days=1)

    day_key = d.strftime("%Y-%m-%d")
    store["current_view_day"] = day_key
    save_data(data)

    txt, _ = render_day_window(chat_id, day_key)
    kb = build_main_keyboard(day_key, chat_id)
    bot.send_message(chat_id, txt, reply_markup=kb, parse_mode="HTML")


@bot.message_handler(commands=["next"])
def handle_next(msg):
    chat_id = msg.chat.id
    if not require_finance(chat_id):
        return

    store = get_chat_store(chat_id)
    cur = store.get("current_view_day") or today_key()
    try:
        d = datetime.strptime(cur, "%Y-%m-%d") + timedelta(days=1)
    except ValueError:
        d = datetime.strptime(today_key(), "%Y-%m-%d") + timedelta(days=1)

    day_key = d.strftime("%Y-%m-%d")
    store["current_view_day"] = day_key
    save_data(data)

    txt, _ = render_day_window(chat_id, day_key)
    kb = build_main_keyboard(day_key, chat_id)
    bot.send_message(chat_id, txt, reply_markup=kb, parse_mode="HTML")


@bot.message_handler(commands=["balance"])
def handle_balance(msg):
    chat_id = msg.chat.id
    if not require_finance(chat_id):
        return

    store = get_chat_store(chat_id)
    bal = store.get("balance", 0)
    bot.send_message(chat_id, f"üí∞ –û–°–¢–ê–¢–û–ö –ø–æ —ç—Ç–æ–º—É —á–∞—Ç—É: {fmt_num(bal)}")


@bot.message_handler(commands=["report"])
def handle_report(msg):
    chat_id = msg.chat.id
    if not require_finance(chat_id):
        return

    store = get_chat_store(chat_id)
    lines = ["üìä –û—Ç—á—ë—Ç –ø–æ –¥–Ω—è–º:"]
    for dk, recs in sorted(store.get("daily_records", {}).items()):
        day_sum = sum(r["amount"] for r in recs)
        lines.append(f"{dk}: {fmt_num(day_sum)}")

    bot.send_message(chat_id, "\n".join(lines))


# ==========================================================
# SECTION 21 ‚Äî CSV/JSON: –¥–µ–Ω—å, —á–∞—Ç, –≤—Å–µ —á–∞—Ç—ã
# ==========================================================

def cmd_csv_day(chat_id: int, day_key: str):
    """
    CSV —Ç–æ–ª—å–∫–æ –∑–∞ –æ–¥–∏–Ω –¥–µ–Ω—å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞.
    """
    if not require_finance(chat_id):
        return

    store = get_chat_store(chat_id)
    day_recs = store.get("daily_records", {}).get(day_key, [])
    if not day_recs:
        bot.send_message(chat_id, "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å.")
        return

    tmp_name = f"data_{chat_id}_{day_key}.csv"
    try:
        with open(tmp_name, "w", newline="", encoding="utf-8") as f:
            w = csv.writer(f)
            w.writerow(["chat_id", "ID", "short_id", "timestamp",
                        "amount", "note", "owner", "day_key"])
            for r in day_recs:
                w.writerow([
                    chat_id,
                    r.get("id"),
                    r.get("short_id"),
                    r.get("timestamp"),
                    r.get("amount"),
                    r.get("note"),
                    r.get("owner"),
                    day_key,
                ])

        upload_to_gdrive(tmp_name)

        with open(tmp_name, "rb") as f:
            bot.send_document(chat_id, f,
                              caption=f"üìÖ CSV –∑–∞ –¥–µ–Ω—å {day_key}")
    except Exception as e:
        log_error(f"cmd_csv_day: {e}")
    finally:
        try:
            os.remove(tmp_name)
        except FileNotFoundError:
            pass


def export_chat_csv_for_callback(chat_id: int):
    """
    CSV —ç—Ç–æ–≥–æ —á–∞—Ç–∞ –¥–ª—è callback-–∫–Ω–æ–ø–æ–∫ (–º–µ–Ω—é ¬´–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å¬ª).
    """
    if not require_finance(chat_id):
        return

    save_chat_json(chat_id)
    per_csv = chat_csv_file(chat_id)

    if os.path.exists(per_csv):
        upload_to_gdrive(per_csv)
        with open(per_csv, "rb") as f:
            sent = bot.send_document(chat_id, f,
                                     caption="üìÇ CSV —ç—Ç–æ–≥–æ —á–∞—Ç–∞")
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –º–æ–∂–Ω–æ –∑–∞–ø–æ–º–Ω–∏—Ç—å file_id/message_id –≤ csv_meta
        meta = _load_csv_meta()
        meta[f"file_id_chat_{chat_id}"] = sent.document.file_id
        meta[f"msg_id_chat_{chat_id}"] = sent.message_id
        _save_csv_meta(meta)

    send_backup_to_channel(chat_id)


@bot.message_handler(commands=["csv"])
def handle_csv(msg):
    """
    CSV —ç—Ç–æ–≥–æ —á–∞—Ç–∞ –ø–æ –∫–æ–º–∞–Ω–¥–µ /csv.
    """
    chat_id = msg.chat.id
    export_chat_csv_for_callback(chat_id)


def cmd_csv_all(chat_id: int):
    """
    –û–±—â–∏–π CSV –ø–æ –≤—Å–µ–º —á–∞—Ç–∞–º.
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏ –∏–∑ /csv_all, –∏ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±—ç–∫–∞–ø–æ–º.
    """
    if not require_finance(chat_id):
        return

    try:
        export_global_csv(data)
        if not os.path.exists(CSV_FILE):
            bot.send_message(chat_id, "–ì–ª–æ–±–∞–ª—å–Ω—ã–π CSV –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω.")
            return

        upload_to_gdrive(CSV_FILE)

        with open(CSV_FILE, "rb") as f:
            bot.send_document(chat_id, f,
                              caption="üìÇ –ì–ª–æ–±–∞–ª—å–Ω—ã–π CSV (–≤—Å–µ —á–∞—Ç—ã)")
    except Exception as e:
        log_error(f"cmd_csv_all: {e}")


@bot.message_handler(commands=["csv_all"])
def handle_csv_all(msg):
    chat_id = msg.chat.id
    if OWNER_ID and str(chat_id) != str(OWNER_ID):
        bot.send_message(chat_id,
                         "–ì–ª–æ–±–∞–ª—å–Ω—ã–π CSV –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É.")
        return
    cmd_csv_all(chat_id)


@bot.message_handler(commands=["json"])
def handle_json(msg):
    chat_id = msg.chat.id
    if not require_finance(chat_id):
        return

    save_chat_json(chat_id)
    p = chat_json_file(chat_id)

    if os.path.exists(p):
        with open(p, "rb") as f:
            bot.send_document(chat_id, f,
                              caption="üßæ JSON —ç—Ç–æ–≥–æ —á–∞—Ç–∞")
    else:
        bot.send_message(chat_id, "–§–∞–π–ª JSON –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω.")

#9Ô∏è‚É£üîü
# ==========================================================
# SECTION 22 ‚Äî –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –±—ç–∫–∞–ø–æ–≤ (GDrive / –∫–∞–Ω–∞–ª)
# ==========================================================

@bot.message_handler(commands=["backup_gdrive_on"])
def handle_backup_gdrive_on(msg):
    backup_flags["drive"] = True
    save_data(data)
    bot.send_message(msg.chat.id, "‚òÅÔ∏è –ë—ç–∫–∞–ø –≤ Google Drive –≤–∫–ª—é—á—ë–Ω.")


@bot.message_handler(commands=["backup_gdrive_off"])
def handle_backup_gdrive_off(msg):
    backup_flags["drive"] = False
    save_data(data)
    bot.send_message(msg.chat.id, "‚òÅÔ∏è –ë—ç–∫–∞–ø –≤ Google Drive –≤—ã–∫–ª—é—á–µ–Ω.")


@bot.message_handler(commands=["backup_channel_on"])
def handle_backup_channel_on(msg):
    backup_flags["channel"] = True
    save_data(data)
    bot.send_message(msg.chat.id, "üì° –ë—ç–∫–∞–ø –≤ Telegram-–∫–∞–Ω–∞–ª –≤–∫–ª—é—á—ë–Ω.")


@bot.message_handler(commands=["backup_channel_off"])
def handle_backup_channel_off(msg):
    backup_flags["channel"] = False
    save_data(data)
    bot.send_message(msg.chat.id, "üì° –ë—ç–∫–∞–ø –≤ Telegram-–∫–∞–Ω–∞–ª –≤—ã–∫–ª—é—á–µ–Ω.")


# ==========================================================
# SECTION 23 ‚Äî Keep-alive
# ==========================================================

KEEP_ALIVE_SEND_TO_OWNER = False  # –µ—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–ª–∞–¥–µ–ª—å—Ü—É


def keep_alive_task():
    """
    –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏:
    ‚Ä¢ –ø–∏–Ω–≥—É–µ—Ç APP_URL (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
    ‚Ä¢ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –º–æ–∂–µ—Ç —Å–ª–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–ª–∞–¥–µ–ª—å—Ü—É
    """
    while True:
        try:
            # Self-ping (Render/—Ö–æ—Å—Ç–∏–Ω–≥)
            if APP_URL:
                try:
                    resp = requests.get(APP_URL, timeout=10)
                    log_info(f"Keep-alive ping -> {resp.status_code}")
                except Exception as e:
                    log_error(f"Keep-alive self error: {e}")

            # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞ (–µ—Å–ª–∏ –≤–∫–ª—é—á–∏–º —Ñ–ª–∞–≥ –≤—ã—à–µ)
            if KEEP_ALIVE_SEND_TO_OWNER and OWNER_ID:
                try:
                    # —Å—é–¥–∞ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
                    # bot.send_message(int(OWNER_ID), "Keep-alive OK")
                    pass
                except Exception as e:
                    log_error(f"Keep-alive notify error: {e}")

        except Exception as e:
            log_error(f"Keep-alive loop error: {e}")

        time.sleep(max(10, KEEP_ALIVE_INTERVAL_SECONDS))


def start_keep_alive_thread():
    t = threading.Thread(target=keep_alive_task, daemon=True)
    t.start()

#üîüüîü
# ==========================================================
# SECTION 24 ‚Äî Flask webhook
# ==========================================================

@app.route(f"/{BOT_TOKEN}", methods=["POST"])
def webhook():
    try:
        update = request.get_data().decode("utf-8")
        js = json.loads(update)
        bot.process_new_updates([telebot.types.Update.de_json(js)])
    except Exception as e:
        log_error(f"webhook error: {e}")
    return "OK", 200


@app.route("/", methods=["GET"])
def root():
    return "Bot is running", 200


# ==========================================================
# SECTION 25 ‚Äî –§–∏–Ω–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –∑–∞–ø—É—Å–∫–∞
# ==========================================================

def final_run():
    log_info("üöÄ –ó–∞–ø—É—Å–∫ Code_022.1 FINAL 1...")

    # 1) –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    global data
    restored = restore_from_gdrive_if_needed()
    data = load_data()

    # 2) –ï—Å–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ ‚Äî —É–≤–µ–¥–æ–º–ª—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞
    if restored and OWNER_ID:
        try:
            bot.send_message(int(OWNER_ID),
                "‚òÅÔ∏è –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ Google Drive.")
        except Exception:
            pass

    # 3) –ó–∞–ø—É—Å–∫ keep-alive
    start_keep_alive_thread()

    # 4) –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º webhook
    if APP_URL:
        wh_url = f"{APP_URL}/{BOT_TOKEN}"
        try:
            bot.remove_webhook()
        except:
            pass
        time.sleep(1)

        try:
            bot.set_webhook(url=wh_url)
            log_info(f"Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {wh_url}")
        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ webhook: {e}")

    else:
        # fallback polling
        log_info("APP_URL –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –∑–∞–ø—É—Å–∫ polling()")
        bot.infinity_polling(timeout=60, long_polling_timeout=60)


# ==========================================================
# SECTION 26 ‚Äî Main
# ==========================================================

if __name__ == "__main__":
    try:
        final_run()
    except Exception as e:
        log_error(f"MAIN_FATAL: {e}")