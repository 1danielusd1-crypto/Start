# Code_022.2-FINAL (updated from 022.1-FINAL)
#  ‚Ä¢ Full finance UI: day window, edit menu, prev/next/view, 31-day calendar, reports
#  ‚Ä¢ Per-chat storage: isolated balances and daily records
#  ‚Ä¢ CSV export: per-chat + global (/csv_all)
#  ‚Ä¢ Anonymous forwarding (owner-configurable) with ‚û°Ô∏è ‚ÜîÔ∏è ‚¨ÖÔ∏è and ‚úÖ
#  ‚Ä¢ Money format: 1.200,75 ‚Äî thousands ".", decimals ","
# ==========================================================

import os
import json
import csv
import logging
from datetime import datetime, timedelta, timezone
from typing import Dict, Any, List, Optional

import telebot
from telebot import types
from flask import Flask, request

# ==========================================================
# CONFIG
# ==========================================================

BOT_TOKEN = os.getenv("BOT_TOKEN", "").strip()
if not BOT_TOKEN:
    raise RuntimeError("BOT_TOKEN is not set")

OWNER_ID = int(os.getenv("OWNER_ID", "0") or 0)  # –≤–ª–∞–¥–µ–ª–µ—Ü –±–æ—Ç–∞
BACKUP_CHAT_ID = int(os.getenv("BACKUP_CHAT_ID", "0") or 0)  # —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫–∞–Ω–∞–ª/—á–∞—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

DATA_FILE = "data.json"          # –æ—Å–Ω–æ–≤–Ω–æ–π JSON
CSV_GLOBAL_FILE = "data_all.csv" # –æ–±—â–∏–π CSV –ø–æ –≤—Å–µ–º —á–∞—Ç–∞–º

# –ü–∞–ø–∫–∞ –¥–ª—è –ø–µ—Ä-—á–∞—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
DATA_DIR = "data_chats"
os.makedirs(DATA_DIR, exist_ok=True)

# ==========================================================
# LOGGING
# ==========================================================

logging.basicConfig(
    level=logging.INFO,
    format="[%(asctime)s] [%(levelname)s] %(message)s"
)
logger = logging.getLogger(__name__)

def log_info(msg: str):
    logger.info(msg)

def log_error(msg: str):
    logger.error(msg)

# ==========================================================
# BOT & APP
# ==========================================================

bot = telebot.TeleBot(BOT_TOKEN, parse_mode=None)
app = Flask(__name__)

# ==========================================================
# RUNTIME DATA
# ==========================================================

# –û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
# data = {
#   "chats": {
#       str(chat_id): {
#          "balance": int (cents),
#          "daily_records": {
#              "YYYY-MM-DD": [
#                   {
#                       "id": int,
#                       "short_id": str,
#                       "amount": int (cents),
#                       "note": str,
#                       "owner": int,
#                   }, ...
#              ]
#          },
#          "edit_wait": { ... } | None,
#          "current_view_day": "YYYY-MM-DD",
#          "info": { "title": ..., "username": ..., ... },
#       },
#       ...
#   },
#   "next_record_id": int,
#   "forward_modes": { str(chat_id): "none"|"o2c"|"c2o"|"both" }
# }
data: Dict[str, Any] = {
    "chats": {},
    "next_record_id": 1,
    "forward_modes": {},
}

# –ú–Ω–æ–∂–µ—Å—Ç–≤–æ —á–∞—Ç–æ–≤, –≥–¥–µ –≤–∫–ª—é—á—ë–Ω —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º
finance_active_chats = set()

VERSION = "Code_022.2-FINAL"

# ==========================================================
# TIME HELPERS
# ==========================================================

def get_tz() -> timezone:
    # —Ç–≤–æ–π –±–∞–∑–æ–≤—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å ‚Äî UTC-3 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    return timezone(timedelta(hours=-3))

def now_local() -> datetime:
    return datetime.now(get_tz())

def today_key() -> str:
    return now_local().strftime("%Y-%m-%d")

# ==========================================================
# FILE HELPERS
# ==========================================================

def chat_json_path(chat_id: int) -> str:
    return os.path.join(DATA_DIR, f"data_{chat_id}.json")

def chat_csv_path(chat_id: int) -> str:
    return os.path.join(DATA_DIR, f"data_{chat_id}.csv")

def load_json(path: str, default):
    if not os.path.exists(path):
        return default
    try:
        with open(path, "r", encoding="utf-8") as f:
            return json.load(f)
    except Exception as e:
        log_error(f"JSON load error {path}: {e}")
        return default

def save_json(path: str, obj):
    try:
        with open(path, "w", encoding="utf-8") as f:
            json.dump(obj, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"JSON save error {path}: {e}")
# ==========================================================
# DATA INIT & ACCESS
# ==========================================================

def default_chat_store() -> Dict[str, Any]:
    return {
        "balance": 0,  # cents
        "daily_records": {},
        "edit_wait": None,
        "current_view_day": today_key(),
        "info": {},
    }

def load_data():
    global data, finance_active_chats
    base = {
        "chats": {},
        "next_record_id": 1,
        "forward_modes": {},
    }
    d = load_json(DATA_FILE, base)
    for k, v in base.items():
        if k not in d:
            d[k] = v
    data = d
    # –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º finance_active_chats, –µ—Å–ª–∏ –±—ã–ª–æ
    finance_active_chats.clear()
    chats = data.get("chats", {})
    for cid, store in chats.items():
        if store.get("balance", 0) or store.get("daily_records"):
            finance_active_chats.add(int(cid))
    log_info("Data loaded")

def save_data():
    save_json(DATA_FILE, data)

def get_chat_store(chat_id: int) -> Dict[str, Any]:
    chats = data.setdefault("chats", {})
    key = str(chat_id)
    if key not in chats:
        chats[key] = default_chat_store()
    return chats[key]

def update_chat_info_from_message(msg):
    """–°–æ—Ö—Ä–∞–Ω—è–µ–º —É–¥–æ–±–æ—á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞."""
    try:
        chat = msg.chat
        chat_id = chat.id
        store = get_chat_store(chat_id)
        info = store.get("info", {})
        info["id"] = chat_id
        info["type"] = getattr(chat, "type", None)
        title = getattr(chat, "title", None)
        username = getattr(chat, "username", None)
        first_name = getattr(chat, "first_name", None)
        last_name = getattr(chat, "last_name", None)
        if title:
            info["title"] = title
        if username:
            info["username"] = username
        if first_name:
            info["first_name"] = first_name
        if last_name:
            info["last_name"] = last_name
        store["info"] = info
    except Exception as e:
        log_error(f"update_chat_info_from_message: {e}")

def is_finance_enabled(chat_id: int) -> bool:
    return chat_id in finance_active_chats

def require_finance(chat_id: int) -> bool:
    if not is_finance_enabled(chat_id):
        bot.send_message(
            chat_id,
            "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞ –µ—â—ë –Ω–µ –≤–∫–ª—é—á—ë–Ω.\n"
            "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /–ø–æ–µ—Ö–∞–ª–∏, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å —É—á—ë—Ç."
        )
        return False
    return True

# ==========================================================
# MONEY FORMAT & PARSER
# ==========================================================

import re

def fmt_num(x: int) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—É–º–º—É –≤ –∫–æ–ø–µ–π–∫–∞—Ö –≤ –≤–∏–¥–µ '1.200,75'."""
    negative = x < 0
    x = abs(int(x))

    rub = x // 100   # —Ü–µ–ª–∞—è —á–∞—Å—Ç—å
    kop = x % 100    # –∫–æ–ø–µ–π–∫–∏

    # —Ç—ã—Å—è—á–∏ ‚Äî —á–µ—Ä–µ–∑ —Ç–æ—á–∫—É
    rub_str = f"{rub:,}".replace(",", ".")

    result = f"{rub_str},{kop:02d}"
    if negative:
        result = "-" + result
    return result

num_re = re.compile(r'[+\-]?\s*\d(?:[\d\s\._\"\',]*\d)?(?:[.,]\d+)?')

def parse_amount(text: str) -> int:
    """
    –ü–∞—Ä—Å–∏—Ç —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—É—é —Å—É–º–º—É –≤ –ö–û–ü–ï–ô–ö–ò (int).

    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:
      '+1.200,75' -> 120075
      '1 200,75'  -> 120075
      '1,01'      -> 101
      '-2.000,5'  -> -200050
      '1,200.75'  -> 120075
    """
    s = (text or "").strip()
    m = num_re.search(s)
    if not m:
        raise ValueError("no number found")

    s = m.group(0).strip()
    negative = s.startswith("-")
    s = s.lstrip("+-").strip()

    # —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã, –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è, –∞–ø–æ—Å—Ç—Ä–æ—Ñ—ã
    s = s.replace(" ", "").replace("_", "").replace("'", "")

    # –ï—Å–ª–∏ –µ—Å—Ç—å –∏ —Ç–æ—á–∫–∞, –∏ –∑–∞–ø—è—Ç–∞—è ‚Äî –ø–æ—Å–ª–µ–¥–Ω—è—è –∏–∑ –Ω–∏—Ö —Å—á–∏—Ç–∞–µ—Ç—Å—è –¥–µ—Å—è—Ç–∏—á–Ω—ã–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º
    if "." in s and "," in s:
        last_dot = s.rfind(".")
        last_comma = s.rfind(",")
        if last_comma > last_dot:
            # –¥–µ—Å—è—Ç–∏—á–Ω–∞—è –∑–∞–ø—è—Ç–∞—è: 1.200,75 -> 1200,75
            s = s.replace(".", "").replace(",", ".")
        else:
            # –¥–µ—Å—è—Ç–∏—á–Ω–∞—è —Ç–æ—á–∫–∞: 1,200.75 -> 1200.75
            s = s.replace(",", "")
    elif "," in s and "." not in s:
        # —Ç–æ–ª—å–∫–æ –∑–∞–ø—è—Ç–∞—è ‚Äî —Å—á–∏—Ç–∞–µ–º –µ—ë –¥–µ—Å—è—Ç–∏—á–Ω–æ–π
        s = s.replace(".", "").replace(",", ".")
    else:
        # —Ç–æ–ª—å–∫–æ —Ç–æ—á–∫–∞ –∏–ª–∏ –Ω–µ—Ç —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π ‚Äî –∑–∞–ø—è—Ç—ã–µ —Å—á–∏—Ç–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á
        s = s.replace(",", "")

    try:
        value = float(s)
    except ValueError:
        raise ValueError("cannot parse number")

    if negative:
        value = -value

    # –í –∫–æ–ø–µ–π–∫–∞—Ö, —Å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º –¥–æ 2 –∑–Ω–∞–∫–æ–≤
    cents = int(round(value * 100))
    return cents
# ==========================================================
# RECORDS & CSV
# ==========================================================

def next_record_id() -> int:
    rid = data.get("next_record_id", 1)
    data["next_record_id"] = rid + 1
    return rid

def add_record_to_chat(chat_id: int, amount_cents: int, note: str, owner_id: int, day_key: Optional[str] = None):
    store = get_chat_store(chat_id)
    if day_key is None:
        day_key = today_key()
    rec_id = next_record_id()
    rec = {
        "id": rec_id,
        "short_id": f"R{rec_id}",
        "amount": amount_cents,
        "note": note,
        "owner": owner_id,
    }
    daily = store.setdefault("daily_records", {})
    day_list = daily.setdefault(day_key, [])
    day_list.append(rec)

    # –ø–µ—Ä–µ—Å—á—ë—Ç –±–∞–ª–∞–Ω—Å–∞ (–ø–æ –≤—Å–µ–º –¥–Ω—è–º)
    balance = 0
    for dk, recs in daily.items():
        for r in recs:
            balance += r["amount"]
    store["balance"] = balance

    save_chat_json(chat_id)

def update_record_in_chat(chat_id: int, rec_id: int, amount_cents: int, note: str):
    store = get_chat_store(chat_id)
    daily = store.get("daily_records", {})
    found = False
    for dk, recs in daily.items():
        for r in recs:
            if r["id"] == rec_id:
                r["amount"] = amount_cents
                r["note"] = note
                found = True
                break
        if found:
            break
    if found:
        # –ø–µ—Ä–µ—Å—á—ë—Ç –±–∞–ª–∞–Ω—Å–∞
        balance = 0
        for dk, recs in daily.items():
            for r in recs:
                balance += r["amount"]
        store["balance"] = balance
        save_chat_json(chat_id)

def delete_record_in_chat(chat_id: int, rec_id: int):
    store = get_chat_store(chat_id)
    daily = store.get("daily_records", {})
    changed = False
    for dk, recs in list(daily.items()):
        new_recs = [r for r in recs if r["id"] != rec_id]
        if len(new_recs) != len(recs):
            daily[dk] = new_recs
            changed = True
        if not new_recs:
            # –¥–µ–Ω—å –ø—É—Å—Ç–æ–π
            del daily[dk]
            changed = True
    if changed:
        # –ø–µ—Ä–µ—Å—á—ë—Ç –±–∞–ª–∞–Ω—Å–∞
        balance = 0
        for dk, recs in daily.items():
            for r in recs:
                balance += r["amount"]
        store["balance"] = balance
        save_chat_json(chat_id)

def save_chat_json(chat_id: int):
    store = get_chat_store(chat_id)
    out = {
        "chat_id": chat_id,
        "balance": store.get("balance", 0),
        "daily_records": store.get("daily_records", {}),
        "info": store.get("info", {}),
    }
    save_json(chat_json_path(chat_id), out)
    # CSV —ç—Ç–æ–≥–æ —á–∞—Ç–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
    path_csv = chat_csv_path(chat_id)
    try:
        with open(path_csv, "w", encoding="utf-8", newline="") as f:
            w = csv.writer(f, delimiter=";")
            w.writerow(["record_id", "date", "amount_cents", "amount_fmt", "note", "owner_id"])
            daily = store.get("daily_records", {})
            for dk, recs in sorted(daily.items()):
                for r in recs:
                    w.writerow([
                        r["id"],
                        dk,
                        r["amount"],
                        fmt_num(r["amount"]),
                        r.get("note", ""),
                        r.get("owner", ""),
                    ])
    except Exception as e:
        log_error(f"save_chat_json CSV error {chat_id}: {e}")

def export_global_csv():
    """–û–±—â–∏–π CSV –ø–æ –≤—Å–µ–º —á–∞—Ç–∞–º."""
    try:
        with open(CSV_GLOBAL_FILE, "w", encoding="utf-8", newline="") as f:
            w = csv.writer(f, delimiter=";")
            w.writerow(["chat_id", "record_id", "date", "amount_cents", "amount_fmt", "note", "owner_id"])
            chats = data.get("chats", {})
            for cid, store in chats.items():
                daily = store.get("daily_records", {})
                for dk, recs in sorted(daily.items()):
                    for r in recs:
                        w.writerow([
                            cid,
                            r["id"],
                            dk,
                            r["amount"],
                            fmt_num(r["amount"]),
                            r.get("note", ""),
                            r.get("owner", ""),
                        ])
    except Exception as e:
        log_error(f"export_global_csv: {e}")

# ==========================================================
# DAY WINDOW & CALENDAR
# ==========================================================

def render_day_window(chat_id: int, day_key: str) -> str:
    """–¢–µ–∫—Å—Ç –æ–∫–Ω–∞ –¥–Ω—è + –û–°–¢–ê–¢–û–ö –ø–æ —á–∞—Ç—É."""
    store = get_chat_store(chat_id)
    daily = store.get("daily_records", {})
    day_recs = daily.get(day_key, [])

    lines: List[str] = []
    lines.append(f"üìÖ <b>{day_key}</b>")

    if not day_recs:
        lines.append("–ó–∞–ø–∏—Å–µ–π –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Ç.")
    else:
        for r in day_recs:
            amt = r["amount"]
            sign = "‚ûï" if amt >= 0 else "‚ûñ"
            lines.append(f"{sign} {fmt_num(amt)} ‚Äî {r.get('note', '')}")

    lines.append("")
    balance = store.get("balance", 0)
    lines.append(f"üí∞ –û–°–¢–ê–¢–û–ö: {fmt_num(balance)}")

    return "\n".join(lines)

def build_main_keyboard(day_key: str, chat_id: int) -> types.InlineKeyboardMarkup:
    kb = types.InlineKeyboardMarkup(row_width=2)

    kb.row(
        types.InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å", callback_data=f"d:{day_key}:add"),
        types.InlineKeyboardButton("üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"d:{day_key}:edit_menu"),
    )

    kb.row(
        types.InlineKeyboardButton("‚¨ÖÔ∏è –í—á–µ—Ä–∞", callback_data=f"d:{day_key}:prev"),
        types.InlineKeyboardButton("‚û°Ô∏è –ó–∞–≤—Ç—Ä–∞", callback_data=f"d:{day_key}:next"),
    )

    kb.row(
        types.InlineKeyboardButton("üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å", callback_data=f"d:{day_key}:calendar"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data=f"d:{day_key}:report"),
    )

    # –ö–Ω–æ–ø–∫–∞ ¬´–°–µ–≥–æ–¥–Ω—è¬ª, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –Ω–µ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å
    if day_key != today_key():
        kb.row(
            types.InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data=f"d:{today_key()}:open")
        )

    kb.row(
        types.InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ", callback_data=f"d:{day_key}:info"),
        types.InlineKeyboardButton("üí∞ –û–±—â–∏–π –∏—Ç–æ–≥", callback_data=f"d:{day_key}:total"),
    )
    return kb

def build_calendar_keyboard(center_day: datetime, chat_id: int) -> types.InlineKeyboardMarkup:
    """31 –¥–µ–Ω—å, –¥–Ω–∏ —Å –∑–∞–ø–∏—Å—è–º–∏ –ø–æ–º–µ—á–µ–Ω—ã üìù."""
    kb = types.InlineKeyboardMarkup(row_width=4)
    store = get_chat_store(chat_id)
    daily = store.get("daily_records", {})

    start_day = center_day - timedelta(days=15)
    for off in range(0, 32, 4):
        row_btns = []
        for d_off in range(4):
            day = start_day + timedelta(days=off + d_off)
            key = day.strftime("%Y-%m-%d")
            label = day.strftime("%d.%m")
            if key in daily and daily[key]:
                label += "üìù"
            row_btns.append(types.InlineKeyboardButton(label, callback_data=f"d:{key}:open"))
        kb.row(*row_btns)

    kb.row(
        types.InlineKeyboardButton("‚¨ÖÔ∏è ‚àí31", callback_data=f"c:{(center_day - timedelta(days=31)).strftime('%Y-%m-%d')}"),
        types.InlineKeyboardButton("‚û°Ô∏è +31", callback_data=f"c:{(center_day + timedelta(days=31)).strftime('%Y-%m-%d')}"),
    )

    kb.row(
        types.InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data=f"d:{today_key()}:open")
    )

    return kb
# ==========================================================
# EDIT MENU & CSV HELPERS
# ==========================================================

def send_chat_csv(chat_id: int):
    """–≠–∫—Å–ø–æ—Ä—Ç CSV —Ç–æ–ª—å–∫–æ —ç—Ç–æ–≥–æ —á–∞—Ç–∞."""
    if not require_finance(chat_id):
        return
    save_chat_json(chat_id)
    path_csv = chat_csv_path(chat_id)
    if os.path.exists(path_csv):
        with open(path_csv, "rb") as f:
            bot.send_document(chat_id, f, caption="üìÇ CSV —ç—Ç–æ–≥–æ —á–∞—Ç–∞")
    else:
        bot.send_message(chat_id, "–§–∞–π–ª CSV —ç—Ç–æ–≥–æ —á–∞—Ç–∞ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω.")

def send_global_csv(chat_id: int):
    """–û–±—â–∏–π CSV –ø–æ –≤—Å–µ–º —á–∞—Ç–∞–º (–∫–æ–º–∞–Ω–¥–∞ /csv_all)."""
    if chat_id != OWNER_ID:
        bot.send_message(chat_id, "–û–±—â–∏–π CSV –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É.")
        return
    export_global_csv()
    if os.path.exists(CSV_GLOBAL_FILE):
        with open(CSV_GLOBAL_FILE, "rb") as f:
            bot.send_document(chat_id, f, caption="üìÇ –û–±—â–∏–π CSV –ø–æ –≤—Å–µ–º —á–∞—Ç–∞–º")
    else:
        bot.send_message(chat_id, "–û–±—â–∏–π CSV –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω.")

def build_edit_menu_keyboard(day_key: str, chat_id: int) -> types.InlineKeyboardMarkup:
    kb = types.InlineKeyboardMarkup(row_width=2)

    kb.row(
        types.InlineKeyboardButton("üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å", callback_data=f"d:{day_key}:edit_list"),
        types.InlineKeyboardButton("üìÇ CSV —ç—Ç–æ–≥–æ —á–∞—Ç–∞", callback_data=f"d:{day_key}:csv_chat"),
    )

    kb.row(
        types.InlineKeyboardButton("‚ôªÔ∏è –û–±–Ω—É–ª–∏—Ç—å —á–∞—Ç", callback_data=f"d:{day_key}:reset_confirm"),
        types.InlineKeyboardButton("üîÅ –ü–µ—Ä–µ—Å—ã–ª–∫–∞", callback_data=f"d:{day_key}:forward_menu"),
    )

    kb.row(
        types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:back_main"),
    )

    return kb

def send_help(chat_id: int):
    text = (
        "‚ÑπÔ∏è <b>–ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É</b>\n\n"
        "–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/start ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\n"
        "/–ø–æ–µ—Ö–∞–ª–∏ ‚Äî –≤–∫–ª—é—á–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –≤ —ç—Ç–æ–º —á–∞—Ç–µ\n"
        "/csv ‚Äî —ç–∫—Å–ø–æ—Ä—Ç CSV —ç—Ç–æ–≥–æ —á–∞—Ç–∞ (—á–∞—Ç + —Ñ–∞–π–ª)\n"
        "/csv_all ‚Äî –æ–±—â–∏–π CSV –ø–æ –≤—Å–µ–º —á–∞—Ç–∞–º (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü)\n"
        "/json ‚Äî –≤—ã–≥—Ä—É–∑–∫–∞ JSON —ç—Ç–æ–≥–æ —á–∞—Ç–∞\n"
        "/reset, /–æ–±–Ω—É–ª–∏—Ç—å ‚Äî –æ–±–Ω—É–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞\n"
        "/stopforward ‚Äî –æ—Ç–∫–ª—é—á–∏—Ç—å –ø–µ—Ä–µ—Å—ã–ª–∫—É –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞\n"
    )
    bot.send_message(chat_id, text, parse_mode="HTML")
# ==========================================================
# FORWARDING MODES
# ==========================================================

FORWARD_NONE = "none"
FORWARD_OWNER_TO_CHAT = "o2c"
FORWARD_CHAT_TO_OWNER = "c2o"
FORWARD_BOTH = "both"

def get_forward_mode(chat_id: int) -> str:
    return data.get("forward_modes", {}).get(str(chat_id), FORWARD_NONE)

def set_forward_mode(chat_id: int, mode: str):
    fm = data.setdefault("forward_modes", {})
    fm[str(chat_id)] = mode
    save_data()

def mode_label(mode: str, target: str) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å —É—á—ë—Ç–æ–º —Ä–µ–∂–∏–º–∞:
    target: 'o2c' / 'c2o' / 'both'
    """
    base = {
        "o2c": "‚û°Ô∏è",
        "c2o": "‚¨ÖÔ∏è",
        "both": "‚ÜîÔ∏è",
    }[target]
    active = (
        (mode == FORWARD_OWNER_TO_CHAT and target == "o2c")
        or (mode == FORWARD_CHAT_TO_OWNER and target == "c2o")
        or (mode == FORWARD_BOTH and target == "both")
    )
    return base + ("‚úÖ" if active else "")

def resolve_forward_targets_for_owner() -> List[int]:
    """
    –ß–∞—Ç—ã, –∫—É–¥–∞ –≤–ª–∞–¥–µ–ª–µ—Ü —à–ª—ë—Ç ‚û°Ô∏è –∏–ª–∏ ‚ÜîÔ∏è.
    """
    res = []
    for cid, mode in data.get("forward_modes", {}).items():
        if mode in (FORWARD_OWNER_TO_CHAT, FORWARD_BOTH):
            try:
                res.append(int(cid))
            except Exception:
                pass
    return res

def resolve_forward_target_to_owner(chat_id: int) -> bool:
    """
    –ù—É–∂–Ω–æ –ª–∏ –∏–∑ —ç—Ç–æ–≥–æ —á–∞—Ç–∞ —Å–ª–∞—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü—É.
    """
    mode = get_forward_mode(chat_id)
    return mode in (FORWARD_CHAT_TO_OWNER, FORWARD_BOTH)
# ==========================================================
# CALLBACK HANDLER
# ==========================================================

@bot.callback_query_handler(func=lambda c: True)
def on_callback(call: types.CallbackQuery):
    try:
        data_str = call.data or ""
        chat_id = call.message.chat.id

        # —Å–ª—É–∂–µ–±–Ω—ã–π noop
        if data_str == "noop":
            try:
                bot.answer_callback_query(call.id)
            except Exception:
                pass
            return

        # –∫–∞–ª–µ–Ω–¥–∞—Ä—å: c:YYYY-MM-DD
        if data_str.startswith("c:"):
            _, center_str = data_str.split(":", 1)
            center = datetime.strptime(center_str, "%Y-%m-%d")
            kb = build_calendar_keyboard(center, chat_id)
            bot.edit_message_reply_markup(
                chat_id=chat_id,
                message_id=call.message.message_id,
                reply_markup=kb,
            )
            return

        # d:<day_key>:<cmd>
        if data_str.startswith("d:"):
            _, day_key, cmd = data_str.split(":", 2)
            store = get_chat_store(chat_id)

            # –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–Ω—è–º –∏ –æ–∫–Ω–æ
            if cmd == "open":
                txt = render_day_window(chat_id, day_key)
                kb = build_main_keyboard(day_key, chat_id)
                bot.edit_message_text(
                    txt,
                    chat_id=chat_id,
                    message_id=call.message.message_id,
                    reply_markup=kb,
                    parse_mode="HTML",
                )
                store["current_view_day"] = day_key
                save_data()
                return

            if cmd == "prev":
                d = datetime.strptime(day_key, "%Y-%m-%d") - timedelta(days=1)
                new_key = d.strftime("%Y-%m-%d")
                txt = render_day_window(chat_id, new_key)
                kb = build_main_keyboard(new_key, chat_id)
                bot.edit_message_text(
                    txt,
                    chat_id=chat_id,
                    message_id=call.message.message_id,
                    reply_markup=kb,
                    parse_mode="HTML",
                )
                store["current_view_day"] = new_key
                save_data()
                return

            if cmd == "next":
                d = datetime.strptime(day_key, "%Y-%m-%d") + timedelta(days=1)
                new_key = d.strftime("%Y-%m-%d")
                txt = render_day_window(chat_id, new_key)
                kb = build_main_keyboard(new_key, chat_id)
                bot.edit_message_text(
                    txt,
                    chat_id=chat_id,
                    message_id=call.message.message_id,
                    reply_markup=kb,
                    parse_mode="HTML",
                )
                store["current_view_day"] = new_key
                save_data()
                return

            if cmd == "calendar":
                center = datetime.strptime(day_key, "%Y-%m-%d")
                kb = build_calendar_keyboard(center, chat_id)
                bot.edit_message_reply_markup(
                    chat_id=chat_id,
                    message_id=call.message.message_id,
                    reply_markup=kb,
                )
                return

            if cmd == "report":
                if not require_finance(chat_id):
                    return
                store = get_chat_store(chat_id)
                daily = store.get("daily_records", {})
                lines = ["üìä –û—Ç—á—ë—Ç –ø–æ –¥–Ω—è–º:"]
                for dk, recs in sorted(daily.items()):
                    s = sum(r["amount"] for r in recs)
                    lines.append(f"{dk}: {fmt_num(s)}")
                bot.send_message(chat_id, "\n".join(lines))
                return

            if cmd == "total":
                # –∏—Ç–æ–≥ –ø–æ —ç—Ç–æ–º—É —á–∞—Ç—É + –æ–±—â–∏–π
                chats = data.get("chats", {})
                chat_balance = get_chat_store(chat_id).get("balance", 0)
                overall = 0
                for cid, st in chats.items():
                    overall += st.get("balance", 0)
                text = (
                    "üí∞ <b>–û–±—â–∏–π –∏—Ç–æ–≥</b>\n\n"
                    f"‚Ä¢ –ü–æ —ç—Ç–æ–º—É —á–∞—Ç—É: <b>{fmt_num(chat_balance)}</b>\n"
                    f"‚Ä¢ –ü–æ –≤—Å–µ–º —á–∞—Ç–∞–º: <b>{fmt_num(overall)}</b>"
                )
                bot.send_message(chat_id, text, parse_mode="HTML")
                return

            if cmd == "edit_menu":
                kb = build_edit_menu_keyboard(day_key, chat_id)
                bot.edit_message_reply_markup(
                    chat_id=chat_id,
                    message_id=call.message.message_id,
                    reply_markup=kb,
                )
                return

            if cmd == "back_main":
                txt = render_day_window(chat_id, day_key)
                kb = build_main_keyboard(day_key, chat_id)
                bot.edit_message_text(
                    txt,
                    chat_id=chat_id,
                    message_id=call.message.message_id,
                    reply_markup=kb,
                    parse_mode="HTML",
                )
                return

            if cmd == "add":
                if day_key == today_key():
                    prompt = "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –Ω–∞–ø—Ä–∏–º–µ—Ä: +500 –û–±–µ–¥"
                else:
                    prompt = "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, —ç—Ç–æ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å."
                store["edit_wait"] = {"type": "add", "day_key": day_key}
                save_data()
                bot.send_message(chat_id, prompt)
                return

            if cmd == "edit_list":
                daily = store.get("daily_records", {})
                day_recs = daily.get(day_key, [])
                if not day_recs:
                    bot.send_message(chat_id, "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.")
                    return
                kb2 = types.InlineKeyboardMarkup()
                for r in day_recs:
                    lbl = f"{r['short_id']}: {fmt_num(r['amount'])} ‚Äî {r.get('note', '')}"
                    kb2.row(
                        types.InlineKeyboardButton(lbl, callback_data="noop"),
                        types.InlineKeyboardButton("‚úèÔ∏è", callback_data=f"d:{day_key}:edit_rec_{r['id']}"),
                        types.InlineKeyboardButton("‚ùå", callback_data=f"d:{day_key}:del_rec_{r['id']}"),
                    )
                kb2.row(
                    types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:edit_menu")
                )
                bot.send_message(chat_id, "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å:", reply_markup=kb2)
                return

            if cmd.startswith("edit_rec_"):
                rid = int(cmd.split("_")[-1])
                store["edit_wait"] = {"type": "edit", "rec_id": rid, "day_key": day_key}
                save_data()
                bot.send_message(chat_id, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—É–º–º—É –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏.")
                return

            if cmd.startswith("del_rec_"):
                rid = int(cmd.split("_")[-1])
                kb_conf = types.InlineKeyboardMarkup()
                kb_conf.row(
                    types.InlineKeyboardButton("‚úÖ –£–¥–∞–ª–∏—Ç—å", callback_data=f"d:{day_key}:del_ok_{rid}"),
                    types.InlineKeyboardButton("üîô –û—Ç–º–µ–Ω–∞", callback_data=f"d:{day_key}:del_cancel"),
                )
                bot.send_message(chat_id, f"–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å R{rid}?", reply_markup=kb_conf)
                return

            if cmd.startswith("del_ok_"):
                rid = int(cmd.split("_")[-1])
                delete_record_in_chat(chat_id, rid)
                txt = render_day_window(chat_id, day_key)
                kb = build_main_keyboard(day_key, chat_id)
                bot.send_message(chat_id, "–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞.")
                bot.send_message(chat_id, txt, reply_markup=kb, parse_mode="HTML")
                return

            if cmd == "del_cancel":
                bot.send_message(chat_id, "–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
                return

            if cmd == "csv_chat":
                send_chat_csv(chat_id)
                return

            if cmd == "reset_confirm":
                bot.send_message(
                    chat_id,
                    "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞? –ù–∞–ø–∏—à–∏—Ç–µ –î–ê."
                )
                return

            if cmd == "info":
                send_help(chat_id)
                return

            # ---------- –ú–ï–ù–Æ –ü–ï–†–ï–°–´–õ–ö–ò ----------

            if cmd == "forward_menu":
                if chat_id != OWNER_ID:
                    bot.send_message(chat_id, "–ú–µ–Ω—é –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É.")
                    return
                chats = data.get("chats", {})
                kb3 = types.InlineKeyboardMarkup()
                for cid, store_c in chats.items():
                    try:
                        icid = int(cid)
                    except Exception:
                        continue
                    if icid == OWNER_ID:
                        continue
                    info = store_c.get("info", {})
                    title = info.get("title") or info.get("username") or f"–ß–∞—Ç {cid}"
                    kb3.row(
                        types.InlineKeyboardButton(
                            title,
                            callback_data=f"d:{day_key}:fw_chat_{cid}"
                        )
                    )
                kb3.row(
                    types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:back_main")
                )
                bot.send_message(chat_id, "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ—Å—ã–ª–∫–∏:", reply_markup=kb3)
                return

            if cmd.startswith("fw_chat_"):
                if chat_id != OWNER_ID:
                    return
                target_cid = cmd.split("_")[-1]
                try:
                    icid = int(target_cid)
                except Exception:
                    bot.send_message(chat_id, "–û—à–∏–±–∫–∞ chat_id.")
                    return
                mode = get_forward_mode(icid)
                kb4 = types.InlineKeyboardMarkup()
                kb4.row(
                    types.InlineKeyboardButton(
                        mode_label(mode, "o2c"),
                        callback_data=f"d:{day_key}:fw_mode_o2c_{icid}",
                    ),
                    types.InlineKeyboardButton(
                        mode_label(mode, "both"),
                        callback_data=f"d:{day_key}:fw_mode_both_{icid}",
                    ),
                    types.InlineKeyboardButton(
                        mode_label(mode, "c2o"),
                        callback_data=f"d:{day_key}:fw_mode_c2o_{icid}",
                    ),
                )
                kb4.row(
                    types.InlineKeyboardButton("üö´ –í—ã–∫–ª—é—á–∏—Ç—å", callback_data=f"d:{day_key}:fw_mode_none_{icid}")
                )
                kb4.row(
                    types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:forward_menu")
                )
                bot.send_message(chat_id, f"–†–µ–∂–∏–º –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –¥–ª—è —á–∞—Ç–∞ {target_cid}:", reply_markup=kb4)
                return

            if cmd.startswith("fw_mode_"):
                if chat_id != OWNER_ID:
                    return
                parts = cmd.split("_")
                mode_key = parts[2]
                icid = int(parts[3])
                if mode_key == "none":
                    set_forward_mode(icid, FORWARD_NONE)
                    bot.send_message(chat_id, f"–ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å —á–∞—Ç–æ–º {icid} –æ—Ç–∫–ª—é—á–µ–Ω–∞.")
                elif mode_key == "o2c":
                    set_forward_mode(icid, FORWARD_OWNER_TO_CHAT)
                    bot.send_message(chat_id, f"–†–µ–∂–∏–º: —Ç–æ–ª—å–∫–æ ‚û°Ô∏è (–≤–ª–∞–¥–µ–ª–µ—Ü ‚Üí —á–∞—Ç {icid}).")
                elif mode_key == "c2o":
                    set_forward_mode(icid, FORWARD_CHAT_TO_OWNER)
                    bot.send_message(chat_id, f"–†–µ–∂–∏–º: —Ç–æ–ª—å–∫–æ ‚¨ÖÔ∏è (—á–∞—Ç {icid} ‚Üí –≤–ª–∞–¥–µ–ª–µ—Ü).")
                elif mode_key == "both":
                    set_forward_mode(icid, FORWARD_BOTH)
                    bot.send_message(chat_id, f"–†–µ–∂–∏–º: ‚ÜîÔ∏è (–¥–≤—É—Ö—Å—Ç–æ—Ä–æ–Ω–Ω—è—è –ø–µ—Ä–µ—Å—ã–ª–∫–∞ —Å —á–∞—Ç–æ–º {icid}).")
                return

    except Exception as e:
        log_error(f"on_callback error: {e}")
# ==========================================================
# COMMAND HANDLERS
# ==========================================================

@bot.message_handler(commands=["start"])
def cmd_start(msg: types.Message):
    chat_id = msg.chat.id
    update_chat_info_from_message(msg)
    text = (
        f"–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç {VERSION}.\n\n"
        "–ß—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å —É—á—ë—Ç –≤ —ç—Ç–æ–º —á–∞—Ç–µ, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /–ø–æ–µ—Ö–∞–ª–∏.\n"
        "–ü–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è –≤—ã —É–≤–∏–¥–∏—Ç–µ –æ–∫–Ω–æ –¥–Ω—è —Å –∫–Ω–æ–ø–∫–∞–º–∏."
    )
    bot.send_message(chat_id, text)

@bot.message_handler(commands=["–ø–æ–µ—Ö–∞–ª–∏"])
def cmd_poehali(msg: types.Message):
    chat_id = msg.chat.id
    update_chat_info_from_message(msg)
    finance_active_chats.add(chat_id)
    store = get_chat_store(chat_id)
    day_key = store.get("current_view_day") or today_key()
    txt = render_day_window(chat_id, day_key)
    kb = build_main_keyboard(day_key, chat_id)
    bot.send_message(chat_id, "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞.")
    bot.send_message(chat_id, txt, reply_markup=kb, parse_mode="HTML")
    save_data()

@bot.message_handler(commands=["csv"])
def cmd_csv(msg: types.Message):
    chat_id = msg.chat.id
    send_chat_csv(chat_id)

@bot.message_handler(commands=["csv_all"])
def cmd_csv_all_command(msg: types.Message):
    chat_id = msg.chat.id
    send_global_csv(chat_id)

@bot.message_handler(commands=["json"])
def cmd_json(msg: types.Message):
    chat_id = msg.chat.id
    if not require_finance(chat_id):
        return
    save_chat_json(chat_id)
    path = chat_json_path(chat_id)
    if os.path.exists(path):
        with open(path, "rb") as f:
            bot.send_document(chat_id, f, caption="JSON —ç—Ç–æ–≥–æ —á–∞—Ç–∞")
    else:
        bot.send_message(chat_id, "JSON –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω.")

@bot.message_handler(commands=["reset", "–æ–±–Ω—É–ª–∏—Ç—å"])
def cmd_reset(msg: types.Message):
    chat_id = msg.chat.id
    if not require_finance(chat_id):
        return
    bot.send_message(
        chat_id,
        "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞? –ù–∞–ø–∏—à–∏—Ç–µ –î–ê."
    )

@bot.message_handler(commands=["stopforward"])
def cmd_stopforward(msg: types.Message):
    chat_id = msg.chat.id
    set_forward_mode(chat_id, FORWARD_NONE)
    bot.send_message(chat_id, "–ü–µ—Ä–µ—Å—ã–ª–∫–∞ –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞.")

@bot.message_handler(commands=["help", "info"])
def cmd_help(msg: types.Message):
    send_help(msg.chat.id)
# ==========================================================
# MESSAGE HANDLERS ‚Äî TEXT
# ==========================================================

@bot.message_handler(content_types=["text"])
def handle_text(msg: types.Message):
    chat_id = msg.chat.id
    text = (msg.text or "").strip()
    update_chat_info_from_message(msg)

    # ---------- 1) –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Ç–µ–∫—Å—Ç–∞ ----------
    try:
        if chat_id == OWNER_ID:
            # –≤–ª–∞–¥–µ–ª–µ—Ü –ø–∏—à–µ—Ç -> —á–∞—Ç—ã —Å —Ä–µ–∂–∏–º–æ–º o2c / both
            targets = resolve_forward_targets_for_owner()
            for dst in targets:
                try:
                    bot.copy_message(dst, chat_id, msg.message_id)
                except Exception:
                    pass
        else:
            # –∏–∑ —á–∞—Ç–∞ –≤–ª–∞–¥–µ–ª—å—Ü—É, –µ—Å–ª–∏ —Ä–µ–∂–∏–º –ø–æ–∑–≤–æ–ª—è–µ—Ç
            if resolve_forward_target_to_owner(chat_id) and OWNER_ID:
                try:
                    bot.copy_message(OWNER_ID, chat_id, msg.message_id)
                except Exception:
                    pass
    except Exception as e:
        log_error(f"forward text error: {e}")

    # ---------- 2) –õ–æ–≥–∏–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤ ----------
    store = get_chat_store(chat_id)
    wait = store.get("edit_wait")

    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±–Ω—É–ª–µ–Ω–∏—è
    if text.upper() == "–î–ê":
        if not require_finance(chat_id):
            return
        # –æ–±–Ω—É–ª—è–µ–º —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç —á–∞—Ç
        data["chats"][str(chat_id)] = default_chat_store()
        if chat_id in finance_active_chats:
            # —Ä–µ–∂–∏–º –æ—Å—Ç–∞–≤–ª—è–µ–º –≤–∫–ª—é—á–µ–Ω–Ω—ã–º
            finance_active_chats.add(chat_id)
        save_data()
        bot.send_message(chat_id, "–î–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞ –±—ã–ª–∏ –æ–±–Ω—É–ª–µ–Ω—ã.")
        # –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤–æ–µ –æ–∫–Ω–æ
        day_key = today_key()
        txt = render_day_window(chat_id, day_key)
        kb = build_main_keyboard(day_key, chat_id)
        bot.send_message(chat_id, txt, reply_markup=kb, parse_mode="HTML")
        return

    if not wait:
        return

    wtype = wait.get("type")
    day_key = wait.get("day_key") or today_key()

    if wtype == "add":
        try:
            parts = text.split(" ", 1)
            amount_cents = parse_amount(parts[0])
            note = parts[1] if len(parts) > 1 else ""
        except Exception:
            bot.send_message(chat_id, "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—É–º–º—É. –ü—Ä–∏–º–µ—Ä: +500 –û–±–µ–¥")
            return
        add_record_to_chat(chat_id, amount_cents, note, msg.from_user.id, day_key=day_key)
        store["edit_wait"] = None
        save_data()
        txt = render_day_window(chat_id, day_key)
        kb = build_main_keyboard(day_key, chat_id)
        bot.send_message(chat_id, "–ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞.")
        bot.send_message(chat_id, txt, reply_markup=kb, parse_mode="HTML")
        return

    if wtype == "edit":
        rec_id = wait.get("rec_id")
        try:
            parts = text.split(" ", 1)
            amount_cents = parse_amount(parts[0])
            note = parts[1] if len(parts) > 1 else ""
        except Exception:
            bot.send_message(chat_id, "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—É–º–º—É. –ü—Ä–∏–º–µ—Ä: +500 –û–±–µ–¥")
            return
        update_record_in_chat(chat_id, rec_id, amount_cents, note)
        store["edit_wait"] = None
        save_data()
        txt = render_day_window(chat_id, day_key)
        kb = build_main_keyboard(day_key, chat_id)
        bot.send_message(chat_id, "–ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞.")
        bot.send_message(chat_id, txt, reply_markup=kb, parse_mode="HTML")
        return
# ==========================================================
# MESSAGE HANDLERS ‚Äî MEDIA (–ø–µ—Ä–µ—Å—ã–ª–∫–∞)
# ==========================================================

MEDIA_TYPES = [
    "photo", "audio", "document", "video", "voice",
    "video_note", "sticker", "animation",
]

@bot.message_handler(content_types=MEDIA_TYPES)
def handle_media(msg: types.Message):
    chat_id = msg.chat.id
    update_chat_info_from_message(msg)

    try:
        if chat_id == OWNER_ID:
            targets = resolve_forward_targets_for_owner()
            for dst in targets:
                try:
                    bot.copy_message(dst, chat_id, msg.message_id)
                except Exception:
                    pass
        else:
            if resolve_forward_target_to_owner(chat_id) and OWNER_ID:
                try:
                    bot.copy_message(OWNER_ID, chat_id, msg.message_id)
                except Exception:
                    pass
    except Exception as e:
        log_error(f"forward media error: {e}")

# ==========================================================
# (–ó–ê–ì–õ–£–®–ö–ò) GDRIVE ‚Äì –ú–û–ñ–ù–û –í–°–¢–ê–í–ò–¢–¨ –†–ï–ê–õ–¨–ù–£–Æ –õ–û–ì–ò–ö–£ –ü–û–¢–û–ú
# ==========================================================

def upload_to_gdrive(path: str):
    """–ó–∞–≥–ª—É—à–∫–∞. –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –≤—Å—Ç—Ä–æ–∏—Ç—å —Ç–≤–æ—é —Ä–µ–∞–ª—å–Ω—É—é Google Drive-–ª–æ–≥–∏–∫—É."""
    if not os.path.exists(path):
        return
    # TODO: –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    log_info(f"upload_to_gdrive called for {path} (stub)")

def restore_from_gdrive_if_needed():
    """–ó–∞–≥–ª—É—à–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ GDrive."""
    log_info("restore_from_gdrive_if_needed (stub)")

# ==========================================================
# WEBHOOK / POLLING
# ==========================================================

WEBHOOK_URL = os.getenv("WEBHOOK_URL", "").strip()

@app.route("/webhook", methods=["POST"])
def webhook():
    if request.method == "POST":
        try:
            update = request.stream.read().decode("utf-8")
            bot.process_new_updates([telebot.types.Update.de_json(update)])
        except Exception as e:
            log_error(f"webhook error: {e}")
        return "OK", 200

@app.route("/")
def index():
    return f"OK: {VERSION}", 200
# ==========================================================
# MAIN ENTRY
# 

def main():
    load_data()
    restore_from_gdrive_if_needed()

    if WEBHOOK_URL:
        # –†–µ–∂–∏–º webhook
        bot.remove_webhook()
        bot.set_webhook(url=WEBHOOK_URL)
        log_info(f"Webhook set to {WEBHOOK_URL}")
    else:
        # –û–±—ã—á–Ω—ã–π polling
        log_info("Starting polling...")
        bot.infinity_polling(skip_pending=True, timeout=60)

if __name__ == "__main__":
    log_info(f"Starting {VERSION} ...")
    main()