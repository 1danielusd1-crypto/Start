#üü°üü°üü°1/12
# ==========================================================
# üß≠ Code_022.2 FINAL ‚Äî –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–ë–û–†–ö–ê
# –ü–µ—Ä-—á–∞—Ç–æ–≤—ã–π —É—á—ë—Ç, –ø–µ—Ä–µ—Å—ã–ª–∫–∞, —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π UI, –∫–∞–ª–µ–Ω–¥–∞—Ä—å,
# –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä + —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª, –±—ç–∫–∞–ø—ã.
# ==========================================================

# ========== –û–¢–°–ï–ö 1 ‚Äî –ò–º–ø–æ—Ä—Ç—ã –∏ –±–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ==========
import os
import io
import re
import csv
import json
import time
import html
import logging
import threading
from datetime import datetime, timedelta, timezone
from zoneinfo import ZoneInfo

import telebot
from telebot import types
from flask import Flask, request

# ==========================================================
# –ß—Ç–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
# ==========================================================
BOT_TOKEN          = os.getenv("BOT_TOKEN", "").strip()
OWNER_ID           = os.getenv("OWNER_ID", "").strip()
BACKUP_CHAT_ID     = os.getenv("BACKUP_CHAT_ID", "").strip()
WEBHOOK_URL        = os.getenv("WEBHOOK_URL", "").strip()
PORT               = int(os.getenv("PORT", "10000"))
TZ_NAME            = os.getenv("TZ_NAME", "America/Argentina/Buenos_Aires").strip()
USE_WEBHOOK        = os.getenv("USE_WEBHOOK", "0") == "1"

DATA_FILE          = "data.json"
LOG_FILE           = "bot.log"

try:
    LOCAL_TZ = ZoneInfo(TZ_NAME)
except Exception:
    LOCAL_TZ = timezone(timedelta(hours=-3))

VERSION = "Code_022.2 FINAL"

# ==========================================================
# –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
# ==========================================================
os.makedirs("logs", exist_ok=True)

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s",
    handlers=[
        logging.FileHandler(os.path.join("logs", LOG_FILE), encoding="utf-8"),
        logging.StreamHandler(),
    ],
)

def log_info(msg): logging.info(msg)
def log_error(msg): logging.error(msg)

# ==========================================================
# Flask + –±–æ—Ç
# ==========================================================
app = Flask(__name__)
bot = telebot.TeleBot(BOT_TOKEN, parse_mode=None)

# ==========================================================
# ========== –û–¢–°–ï–ö 2 ‚Äî –í—Ä–µ–º—è, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —É—Ç–∏–ª–∏—Ç—ã ==========
# ==========================================================

def now_utc():
    return datetime.now(timezone.utc)

def now_local():
    return now_utc().astimezone(LOCAL_TZ)

def today_key():
    return now_local().strftime("%Y-%m-%d")

def ensure_dirs():
    os.makedirs("data", exist_ok=True)

ensure_dirs()

# ==========================================================
# –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç —á–∏—Å–µ–ª
# ==========================================================
def fmt_num(x: int) -> str:
    """
    –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê (—Ç–≤–æ—è):

    120075 -> '1.200,75'
    101 -> '1,01'
    -150000 -> '-1.500,00'
    """
    negative = x < 0
    x = abs(int(x))

    rub = x // 100
    kop = x % 100

    rub_str = f"{rub:,}".replace(",", ".")
    result = f"{rub_str},{kop:02d}"
    return "-" + result if negative else result

# ==========================================================
# –ü–∞—Ä—Å–µ—Ä —Å—É–º–º—ã (—É–ª—É—á—à–µ–Ω–Ω—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ª—é–±—ã—Ö —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π)
# ==========================================================

_amount_clean_re = re.compile(r"[^\d\-+., ]+")

def parse_amount_token(raw: str) -> int | None:
    """
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
      1 200
      1.200
      1,200
      1.200,50
      -1 200,75
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É–º–º—É –≤ –ö–û–ü–ï–ô–ö–ê–•.
    """

    if not raw:
        return None

    s = _amount_clean_re.sub("", raw.strip())

    # –∑–Ω–∞–∫
    sign = 1
    if s.startswith("-"):
        sign = -1
        s = s[1:].lstrip()
    elif s.startswith("+"):
        s = s[1:].lstrip()

    if not s:
        return None

    # –µ—Å–ª–∏ –µ—Å—Ç—å –∏ . –∏ ,
    if "," in s and "." in s:
        if s.rfind(",") > s.rfind("."):
            s = s.replace(".", "")
            s = s.replace(",", ".")
        else:
            s = s.replace(",", "")

    # –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ –∑–∞–ø—è—Ç–∞—è
    elif "," in s:
        if s.count(",") == 1 and len(s.split(",")[-1]) in (1, 2):
            s = s.replace(",", ".")
        else:
            s = s.replace(",", "")

    # –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ —Ç–æ—á–∫–∞
    elif "." in s:
        if s.count(".") == 1 and len(s.split(".")[-1]) in (1, 2):
            pass
        else:
            s = s.replace(".", "")

    try:
        val = float(s)
        # –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ö–û–ü–ï–ô–ö–ò
        return int(round(sign * val * 100))
    except:
        return None

# ==========================================================
# ========== –û–¢–°–ï–ö 3 ‚Äî –ë–ê–ó–û–í–¨–ï –•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• ==========
# ==========================================================

data_lock = threading.Lock()
data = {}

def load_data():
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç data.json.
    """
    global data
    if not os.path.exists(DATA_FILE):
        data = {"chats": {}, "finance_active_chats": {}, "forward_rules": {}, "known_chats": {}}
        return

    try:
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            d = json.load(f)

        if not isinstance(d, dict):
            raise ValueError("data.json –ø–æ–≤—Ä–µ–∂–¥—ë–Ω")

        d.setdefault("chats", {})
        d.setdefault("finance_active_chats", {})
        d.setdefault("forward_rules", {})
        d.setdefault("known_chats", {})

        data = d
        log_info("data.json –∑–∞–≥—Ä—É–∂–µ–Ω")
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ data.json: {e}")
        data = {"chats": {}, "finance_active_chats": {}, "forward_rules": {}, "known_chats": {}}
#üü°üü°üü°1/12‚¨ÜÔ∏è 2/12‚è¨Ô∏è

# ==========================================================
# ========== –û–¢–°–ï–ö 4 ‚Äî –•—Ä–∞–Ω–µ–Ω–∏–µ per-chat –¥–∞–Ω–Ω—ã—Ö ==========
# ==========================================================

def get_chat_store(chat_id: int) -> dict:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç store –¥–ª—è —á–∞—Ç–∞.
    –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
    """
    cid = str(chat_id)
    chats = data.setdefault("chats", {})

    if cid not in chats:
        chats[cid] = {
            "chat_id": chat_id,
            "daily_records": {},
            "balance": 0,
            "known_days": [],
            "info": {}
        }
    return chats[cid]


def save_chat_json(chat_id: int):
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç data_<chat_id>.json + CSV + meta.
    """
    store = get_chat_store(chat_id)
    cid = str(chat_id)

    # JSON
    try:
        with open(f"data_{cid}.json", "w", encoding="utf-8") as f:
            json.dump(store, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è data_{cid}.json: {e}")

    # CSV
    try:
        rows = []
        for dkey, recs in store.get("daily_records", {}).items():
            for r in recs:
                rows.append([
                    dkey,
                    r.get("id", ""),
                    r.get("short_id", ""),
                    r.get("amount", 0),
                    r.get("note", "")
                ])

        with open(f"data_{cid}.csv", "w", newline="", encoding="utf-8") as f:
            w = csv.writer(f, delimiter=";")
            w.writerow(["date", "id", "short_id", "amount", "note"])
            w.writerows(rows)
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ CSV data_{cid}.csv: {e}")

    # META
    try:
        meta = {
            "chat_id": chat_id,
            "updated": now_local().isoformat(timespec="seconds"),
            "records": sum(len(v) for v in store.get("daily_records", {}).values())
        }
        with open(f"csv_meta_{cid}.json", "w", encoding="utf-8") as f:
            json.dump(meta, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ csv_meta_{cid}.json: {e}")


# ==========================================================
# ========== –û–¢–°–ï–ö 5 ‚Äî update_chat_info_from_message ==========
# ==========================================================

def update_chat_info_from_message(msg):
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç real title / first_name / last_name / username —á–∞—Ç–∞.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ handle_text, handle_media, start, –ø–æ–µ—Ö–∞–ª–∏, callback.
    """
    if not msg:
        return

    chat = msg.chat
    if not chat:
        return

    cid = str(chat.id)
    store = get_chat_store(chat.id)

    info = {
        "id": chat.id,
        "type": chat.type,
        "title": getattr(chat, "title", None),
        "username": getattr(chat, "username", None),
        "first_name": getattr(chat, "first_name", None),
        "last_name": getattr(chat, "last_name", None),
    }

    store["info"] = info

    # –æ–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π known_chats
    kc = data.setdefault("known_chats", {})
    kc[cid] = info

    save_data()


# ==========================================================
# ========== –û–¢–°–ï–ö 6 ‚Äî SAVE DATA ==========
# ==========================================================

def save_data(current=None):
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç data.json –ë–ï–ó —Ç—è–∂—ë–ª—ã—Ö per-chat –¥–∞–Ω–Ω—ã—Ö.
    forward_rules –∏ known_chats —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è.
    """
    with data_lock:
        doc = current if current else data

        try:
            minimal = {
                "chats": {},
                "finance_active_chats": doc.get("finance_active_chats", {}),
                "forward_rules": doc.get("forward_rules", {}),
                "known_chats": doc.get("known_chats", {})
            }

            # —Ç–æ–ª—å–∫–æ —Å–ª—É–∂–µ–±–Ω–∞—è –∏–Ω—Ñ–∞ –ø–æ —á–∞—Ç–∞–º (–±–µ–∑ daily_records)
            for cid, st in doc.get("chats", {}).items():
                minimal["chats"][cid] = {
                    "chat_id": st.get("chat_id"),
                    "balance": st.get("balance", 0),
                    "known_days": st.get("known_days", []),
                    "info": st.get("info", {})
                }

            with open(DATA_FILE, "w", encoding="utf-8") as f:
                json.dump(minimal, f, ensure_ascii=False, indent=2)

            log_info("üíæ data.json —Å–æ—Ö—Ä–∞–Ω—ë–Ω")
        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è data.json: {e}")
#2/12‚¨ÜÔ∏è

# ==========================================================
# ========== –û–¢–°–ï–ö 7 ‚Äî –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º ==========
# ==========================================================

def is_finance_mode(chat_id: int) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –≤–∫–ª—é—á—ë–Ω –ª–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –≤ –¥–∞–Ω–Ω–æ–º —á–∞—Ç–µ.
    """
    return bool(data.get("finance_active_chats", {}).get(str(chat_id), False))


def set_finance_mode(chat_id: int, enabled: bool):
    """
    –í–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
    """
    fa = data.setdefault("finance_active_chats", {})
    fa[str(chat_id)] = bool(enabled)
    save_data()


def require_finance(chat_id: int) -> bool:
    """
    –ï—Å–ª–∏ —Ñ–∏–Ω. —Ä–µ–∂–∏–º –Ω–µ –≤–∫–ª—é—á—ë–Ω ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∫—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç False.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö —Å —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ (–∫—Ä–æ–º–µ /start –∏ /–ø–æ–µ—Ö–∞–ª–∏).
    """
    if not is_finance_mode(chat_id):
        try:
            bot.send_message(
                chat_id,
                "‚öôÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º —Å–µ–π—á–∞—Å –≤—ã–∫–ª—é—á–µ–Ω.\n"
                "–ß—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å —É—á—ë—Ç –≤ —ç—Ç–æ–º —á–∞—Ç–µ, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É: /–ø–æ–µ—Ö–∞–ª–∏",
            )
        except Exception as e:
            log_error(f"require_finance send_message: {e}")
        return False
    return True


# ==========================================================
# ========== –û–¢–°–ï–ö 8 ‚Äî –ó–∞–ø–∏—Å–∏ (add / edit / delete) ==========
#  –í–ê–ñ–ù–û: amount —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ö–û–ü–ï–ô–ö–ê–•
# ==========================================================

def add_record(chat_id: int, day_key: str, amount: int, note: str) -> dict:
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ daily_records —á–∞—Ç–∞.
    amount ‚Äî –≤ –∫–æ–ø–µ–π–∫–∞—Ö (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å fmt_num).
    """
    store = get_chat_store(chat_id)
    daily = store.setdefault("daily_records", {})
    recs = daily.setdefault(day_key, [])

    new_id = (recs[-1]["id"] + 1) if recs else 1
    short_id = f"R{new_id}"

    rec = {
        "id": new_id,
        "short_id": short_id,
        "amount": amount,
        "note": note,
        "created": now_local().isoformat(timespec="seconds"),
    }
    recs.append(rec)

    # –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å (–≤ –∫–æ–ø–µ–π–∫–∞—Ö)
    cur_bal = store.get("balance", 0)
    store["balance"] = cur_bal + amount

    # —Å–ø–∏—Å–æ–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –¥–Ω–µ–π
    known_days = set(store.get("known_days", []))
    known_days.add(day_key)
    store["known_days"] = sorted(known_days)

    save_chat_json(chat_id)
    save_data()
    return rec


def get_record(chat_id: int, day_key: str, rid: int) -> dict | None:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞–ø–∏—Å—å –ø–æ ID (rid) –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –¥–µ–Ω—å.
    """
    store = get_chat_store(chat_id)
    daily = store.get("daily_records", {})
    recs = daily.get(day_key, [])
    for r in recs:
        if r.get("id") == rid:
            return r
    return None


def delete_record(chat_id: int, day_key: str, rid: int) -> dict | None:
    """
    –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –ø–æ ID.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–¥–∞–ª—ë–Ω–Ω—É—é –∑–∞–ø–∏—Å—å (dict) –∏–ª–∏ None.
    """
    store = get_chat_store(chat_id)
    daily = store.get("daily_records", {})
    recs = daily.get(day_key, [])

    new_list = []
    removed = None
    diff = 0

    for r in recs:
        if r.get("id") == rid:
            removed = r
            diff = -r.get("amount", 0)
        else:
            new_list.append(r)

    if removed is None:
        return None

    daily[day_key] = new_list

    # –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
    store["balance"] = store.get("balance", 0) + diff

    # –µ—Å–ª–∏ –∑–∞ –¥–µ–Ω—å –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–µ–π ‚Äî —É–±–∏—Ä–∞–µ–º –∏–∑ known_days
    if not new_list:
        kd = set(store.get("known_days", []))
        if day_key in kd:
            kd.remove(day_key)
        store["known_days"] = sorted(kd)

    save_chat_json(chat_id)
    save_data()
    return removed


def edit_record(chat_id: int, day_key: str, rid: int, new_amount: int, new_note: str) -> bool:
    """
    –ò–∑–º–µ–Ω—è–µ—Ç —Å—É–º–º—É –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∑–∞–ø–∏—Å–∏.
    new_amount ‚Äî –≤ –∫–æ–ø–µ–π–∫–∞—Ö.
    """
    store = get_chat_store(chat_id)
    daily = store.get("daily_records", {})
    recs = daily.get(day_key, [])

    old_amount = None
    changed = False

    for r in recs:
        if r.get("id") == rid:
            old_amount = r.get("amount", 0)
            r["amount"] = new_amount
            r["note"] = new_note
            r["edited"] = now_local().isoformat(timespec="seconds")
            changed = True
            break

    if not changed:
        return False

    # –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –±–∞–ª–∞–Ω—Å
    store["balance"] = store.get("balance", 0) - old_amount + new_amount

    save_chat_json(chat_id)
    save_data()
    return True


# ==========================================================
# ========== –û–¢–°–ï–ö 9 ‚Äî –û–∫–Ω–æ –¥–Ω—è (—Ä–µ–Ω–¥–µ—Ä + –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞) ==========
# ==========================================================

_active_windows: dict[str, int] = {}


def set_active_window_id(chat_id: int, msg_id: int):
    _active_windows[str(chat_id)] = msg_id


def get_active_window_id(chat_id: int) -> int | None:
    return _active_windows.get(str(chat_id))


def render_day_window(chat_id: int, day_key: str) -> tuple[str, list]:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –æ–∫–Ω–∞ –¥–Ω—è + –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π.
    –í—Å–µ —Å—É–º–º—ã –≤ –æ–∫–Ω–µ ‚Äî —É–∂–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ fmt_num.
    """
    store = get_chat_store(chat_id)
    daily = store.get("daily_records", {})
    recs = daily.get(day_key, [])

    try:
        dt = datetime.strptime(day_key, "%Y-%m-%d")
        date_str = dt.strftime("%d.%m.%Y (%A)")
    except Exception:
        date_str = day_key

    lines = [f"üìÖ <b>{html.escape(date_str)}</b>"]

    if not recs:
        lines.append("–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å.")
    else:
        for r in recs:
            am = fmt_num(r.get("amount", 0))
            nt = r.get("note", "") or ""
            sid = r.get("short_id", "")
            lines.append(f"{sid}: {am} ‚Äî {html.escape(nt)}")

    bal = store.get("balance", 0)
    lines.append("")
    lines.append(f"üí∞ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: <b>{fmt_num(bal)}</b>")

    return "\n".join(lines), recs


def build_main_keyboard(day_key: str, chat_id: int | None = None) -> types.InlineKeyboardMarkup:
    """
    –û—Å–Ω–æ–≤–Ω–æ–µ inline-–º–µ–Ω—é –æ–∫–Ω–∞ –¥–Ω—è.
    """
    kb = types.InlineKeyboardMarkup(row_width=2)

    kb.row(
        types.InlineKeyboardButton("üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"d:{day_key}:edit_list"),
        types.InlineKeyboardButton("üí∞ –û–±—â–∏–π –∏—Ç–æ–≥", callback_data=f"d:{day_key}:total"),
    )

    kb.row(
        types.InlineKeyboardButton("‚¨ÖÔ∏è –í—á–µ—Ä–∞", callback_data=f"d:{day_key}:prev"),
        types.InlineKeyboardButton("‚û°Ô∏è –ó–∞–≤—Ç—Ä–∞", callback_data=f"d:{day_key}:next"),
    )

    kb.row(
        types.InlineKeyboardButton("üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å", callback_data=f"d:{day_key}:calendar"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data=f"d:{day_key}:report"),
    )

    kb.row(
        types.InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ", callback_data=f"d:{day_key}:info"),
    )

    return kb


def update_or_send_day_window(chat_id: int, day_key: str):
    """
    –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –æ–∫–Ω–æ –¥–Ω—è, –µ—Å–ª–∏ –æ–Ω–æ —É–∂–µ –µ—Å—Ç—å.
    –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
    """
    text, _ = render_day_window(chat_id, day_key)
    kb = build_main_keyboard(day_key, chat_id)

    mid = get_active_window_id(chat_id)
    if mid:
        try:
            bot.edit_message_text(
                text,
                chat_id=chat_id,
                message_id=mid,
                reply_markup=kb,
                parse_mode="HTML",
            )
            return
        except Exception as e:
            log_error(f"edit_message_text fail: {e}")

    # –µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å ‚Äî —à–ª—ë–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    try:
        m = bot.send_message(chat_id, text, reply_markup=kb, parse_mode="HTML")
        set_active_window_id(chat_id, m.message_id)
    except Exception as e:
        log_error(f"send_message (new window) error: {e}")
# 3 /12‚¨ÜÔ∏è

# ==========================================================
# ========== –û–¢–°–ï–ö 10 ‚Äî –ö–∞–ª–µ–Ω–¥–∞—Ä—å (31 –¥–µ–Ω—å) ==========
# ==========================================================

def build_calendar_keyboard(center_day: datetime, chat_id: int) -> types.InlineKeyboardMarkup:
    """
    –ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ 31 –¥–µ–Ω—å.
    –î–Ω–∏ —Å –∑–∞–ø–∏—Å—è–º–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è —Ç–æ—á–∫–æ–π "‚Ä¢".
    """
    kb = types.InlineKeyboardMarkup(row_width=4)

    store = get_chat_store(chat_id)
    daily = store.get("daily_records", {})

    start_day = center_day - timedelta(days=15)

    # 8 —Å—Ç—Ä–æ–∫ –ø–æ 4 –¥–Ω—è (32 –¥–Ω—è)
    for row_index in range(0, 32, 4):
        row = []
        for offset in range(4):
            day = start_day + timedelta(days=row_index + offset)
            dkey = day.strftime("%Y-%m-%d")
            label = day.strftime("%d.%m")

            # –ø–æ–º–µ—á–∞–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏
            if dkey in daily and daily[dkey]:
                label = "‚Ä¢" + label

            row.append(
                types.InlineKeyboardButton(
                    label,
                    callback_data=f"d:{dkey}:open"
                )
            )
        kb.row(*row)

    # –∫–Ω–æ–ø–∫–∏ –≤–ø–µ—Ä–µ–¥/–Ω–∞–∑–∞–¥ –Ω–∞ –º–µ—Å—è—Ü
    kb.row(
        types.InlineKeyboardButton(
            "‚¨ÖÔ∏è ‚àí31", callback_data=f"c:{(center_day - timedelta(days=31)).strftime('%Y-%m-%d')}"
        ),
        types.InlineKeyboardButton(
            "‚û°Ô∏è +31", callback_data=f"c:{(center_day + timedelta(days=31)).strftime('%Y-%m-%d')}"
        ),
    )

    # —Å–µ–≥–æ–¥–Ω—è
    kb.row(
        types.InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data=f"d:{today_key()}:open")
    )

    # –∫–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥
    kb.row(
        types.InlineKeyboardButton(
            "üîô –ù–∞–∑–∞–¥",
            callback_data=f"back:day:{center_day.strftime('%Y-%m-%d')}"
        )
    )

    return kb


# ==========================================================
# ========== –û–¢–°–ï–ö 11 ‚Äî –ò–Ω—Ñ–æ / –û—Ç—á—ë—Ç / –ë–∞–ª–∞–Ω—Å ==========
# ==========================================================

def cmd_info(chat_id: int, day_key: str):
    """
    –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –∏–Ω—Ñ–æ-–ø–∞–Ω–µ–ª—å —Å –∫–Ω–æ–ø–∫–æ–π –ù–∞–∑–∞–¥.
    """
    txt = (
        f"<b>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç</b>, –≤–µ—Ä—Å–∏—è <b>{VERSION}</b>\n\n"
        "‚ûï –í–≤–æ–¥ —Å—É–º–º—ã: <b>+500 –û–±–µ–¥</b>\n"
        "‚ûñ –í–≤–æ–¥ —Å—É–º–º—ã: <b>-150 –ú–∞–≥–∞–∑–∏–Ω</b>\n\n"
        "üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å ‚Äî –≤—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å\n"
        "üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å–∏\n"
        "‚¨ÖÔ∏è‚û°Ô∏è ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º\n"
        "üìä –û—Ç—á—ë—Ç ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –¥–Ω—é\n"
        "üí∞ –û–±—â–∏–π –∏—Ç–æ–≥ ‚Äî –±–∞–ª–∞–Ω—Å –ø–æ —á–∞—Ç—É\n"
    )

    kb = types.InlineKeyboardMarkup()
    kb.add(
        types.InlineKeyboardButton(
            "üîô –ù–∞–∑–∞–¥",
            callback_data=f"back:day:{day_key}"
        )
    )

    bot.send_message(chat_id, txt, parse_mode="HTML", reply_markup=kb)


def cmd_total(chat_id: int):
    """
    –ò—Ç–æ–≥ –ø–æ —á–∞—Ç—É: —Å—É–º–º–∞ –±–∞–ª–∞–Ω—Å–∞.
    """
    store = get_chat_store(chat_id)
    bal = store.get("balance", 0)

    kb = types.InlineKeyboardMarkup()
    kb.add(
        types.InlineKeyboardButton(
            "üîô –ù–∞–∑–∞–¥",
            callback_data=f"back:day:{today_key()}"
        )
    )

    bot.send_message(
        chat_id,
        f"üí∞ –ë–∞–ª–∞–Ω—Å —á–∞—Ç–∞: <b>{fmt_num(bal)}</b>",
        reply_markup=kb,
        parse_mode="HTML",
    )


def cmd_report(chat_id: int, day_key: str):
    """
    –û—Ç—á—ë—Ç –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å.
    –í–∫–ª—é—á–∞–µ—Ç –∫–Ω–æ–ø–∫—É –ù–∞–∑–∞–¥.
    """
    store = get_chat_store(chat_id)
    recs = store.get("daily_records", {}).get(day_key, [])

    if not recs:
        kb = types.InlineKeyboardMarkup().add(
            types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"back:day:{day_key}")
        )
        return bot.send_message(chat_id, "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å.", reply_markup=kb)

    inc = 0
    exp = 0
    for r in recs:
        am = r.get("amount", 0)
        if am >= 0:
            inc += am
        else:
            exp += am

    lines = [
        f"üìä –û—Ç—á—ë—Ç –∑–∞ {day_key}",
        f"‚ûï –î–æ—Ö–æ–¥: {fmt_num(inc)}",
        f"‚ûñ –†–∞—Å—Ö–æ–¥: {fmt_num(exp)}",
        f"üí∞ –ò—Ç–æ–≥–æ: {fmt_num(inc + exp)}",
    ]

    kb = types.InlineKeyboardMarkup().add(
        types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"back:day:{day_key}")
    )

    bot.send_message(chat_id, "\n".join(lines), reply_markup=kb)


def cmd_balance(chat_id: int):
    """
    –°–∏–Ω–æ–Ω–∏–º –∫ total (–Ω–æ –±–µ–∑ inline ¬´–ù–∞–∑–∞–¥¬ª).
    –ö–æ–º–∞–Ω–¥–∞ /balance.
    """
    store = get_chat_store(chat_id)
    bal = store.get("balance", 0)
    bot.send_message(
        chat_id,
        f"üí∞ –ë–∞–ª–∞–Ω—Å —á–∞—Ç–∞: <b>{fmt_num(bal)}</b>",
        parse_mode="HTML"
    )


# ==========================================================
# ========== –û–¢–°–ï–ö 12 ‚Äî –ú–µ–Ω—é ¬´–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å¬ª ==========
# ==========================================================

def open_edit_list(chat_id: int, day_key: str):
    """
    –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π –∑–∞ –¥–µ–Ω—å.
    –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–Ω–æ–ø–∫–∏ ‚úè / ‚ùå –∏ –∫–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥.
    """
    if not require_finance(chat_id):
        return

    store = get_chat_store(chat_id)
    recs = store.get("daily_records", {}).get(day_key, [])

    lines = [f"üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π: <b>{day_key}</b>"]

    kb = types.InlineKeyboardMarkup(row_width=2)

    if not recs:
        lines.append("–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π.")
    else:
        for r in recs:
            sid = r["short_id"]
            am = fmt_num(r["amount"])
            nt = html.escape(r.get("note", ""))

            lines.append(f"{sid}: {am} ‚Äî {nt}")

            kb.row(
                types.InlineKeyboardButton("‚úè", callback_data=f"edit:{day_key}:{r['id']}"),
                types.InlineKeyboardButton("‚ùå", callback_data=f"del:{day_key}:{r['id']}"),
            )

    # –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
    kb.row(
        types.InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é", callback_data=f"add:{day_key}:0")
    )

    # –∫–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥
    kb.row(
        types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"back:day:{day_key}")
    )

    bot.send_message(
        chat_id,
        "\n".join(lines),
        reply_markup=kb,
        parse_mode="HTML",
    )
# 4 /12‚¨ÜÔ∏è

# ==========================================================
# ========== –û–¢–°–ï–ö 13 ‚Äî Pending-—Ä–µ–∂–∏–º—ã (add / edit) ==========
# ==========================================================

_pending_add: dict[int, str] = {}      # chat_id -> day_key
_pending_edit: dict[int, tuple[str, int]] = {}  # chat_id -> (day_key, record_id)


def handle_pending_add(msg: types.Message):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–æ–¥ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è ¬´‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é¬ª.
    """
    chat_id = msg.chat.id
    text = (msg.text or "").strip()
    day_key = _pending_add.pop(chat_id, None)

    if not day_key:
        return

    tokens = text.split(maxsplit=1)
    if not tokens:
        return bot.send_message(chat_id, "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü—Ä–∏–º–µ—Ä: +500 –û–±–µ–¥")

    amount = parse_amount_token(tokens[0])
    if amount is None:
        return bot.send_message(chat_id, "–ù–µ —Å–º–æ–≥ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—É–º–º—É. –ü—Ä–∏–º–µ—Ä: +500 –û–±–µ–¥")

    note = tokens[1] if len(tokens) > 1 else ""

    add_record(chat_id, day_key, amount, note)
    update_or_send_day_window(chat_id, day_key)
    bot.send_message(chat_id, "–ì–æ—Ç–æ–≤–æ!")

    # –∫–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥ –∫ –æ–∫–Ω—É –¥–Ω—è
    kb = types.InlineKeyboardMarkup().add(
        types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"back:day:{day_key}")
    )
    bot.send_message(chat_id, "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–∫–Ω—É –¥–Ω—è:", reply_markup=kb)


def handle_pending_edit(msg: types.Message):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è ‚úè.
    """
    chat_id = msg.chat.id
    text = (msg.text or "").strip()

    if chat_id not in _pending_edit:
        return

    day_key, rid = _pending_edit.pop(chat_id)

    tokens = text.split(maxsplit=1)
    if not tokens:
        return bot.send_message(chat_id, "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü—Ä–∏–º–µ—Ä: -200 –ú–∞–≥–∞–∑–∏–Ω")

    amount = parse_amount_token(tokens[0])
    if amount is None:
        return bot.send_message(chat_id, "–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞.")

    note = tokens[1] if len(tokens) > 1 else ""

    ok = edit_record(chat_id, day_key, rid, amount, note)
    if not ok:
        return bot.send_message(chat_id, "–û—à–∏–±–∫–∞: –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")

    update_or_send_day_window(chat_id, day_key)
    bot.send_message(chat_id, "–ò–∑–º–µ–Ω–µ–Ω–æ!")

    kb = types.InlineKeyboardMarkup().add(
        types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"back:day:{day_key}")
    )
    bot.send_message(chat_id, "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–∫–Ω—É –¥–Ω—è:", reply_markup=kb)


# ==========================================================
# ========== –û–¢–°–ï–ö 14 ‚Äî Callback add / edit / delete ==========
# ==========================================================

@bot.callback_query_handler(func=lambda c: c.data.startswith("add:"))
def cb_add_record(c: types.CallbackQuery):
    try:
        _, day_key, _ = c.data.split(":")
        chat_id = c.message.chat.id

        if not require_finance(chat_id):
            return

        _pending_add[chat_id] = day_key
        bot.answer_callback_query(c.id)
        bot.send_message(
            chat_id,
            f"‚ûï –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
            f"+500 –û–±–µ–¥\n-200 –ú–∞–≥–∞–∑–∏–Ω\n\n–î–µ–Ω—å: {day_key}",
        )
    except Exception as e:
        log_error(f"cb_add_record: {e}")


@bot.callback_query_handler(func=lambda c: c.data.startswith("del:"))
def cb_delete_record(c: types.CallbackQuery):
    try:
        _, day_key, rid = c.data.split(":")
        chat_id = c.message.chat.id
        rid_int = int(rid)

        if not require_finance(chat_id):
            return

        removed = delete_record(chat_id, day_key, rid_int)
        if removed:
            bot.answer_callback_query(c.id, "–£–¥–∞–ª–µ–Ω–æ")
            bot.send_message(chat_id, f"{removed.get('short_id','')}: (—É–¥–∞–ª–µ–Ω–æ)")
        else:
            bot.answer_callback_query(c.id, "–ù–µ –Ω–∞–π–¥–µ–Ω–æ")

        update_or_send_day_window(chat_id, day_key)
    except Exception as e:
        log_error(f"cb_delete_record: {e}")


@bot.callback_query_handler(func=lambda c: c.data.startswith("edit:"))
def cb_edit_record(c: types.CallbackQuery):
    try:
        _, day_key, rid = c.data.split(":")
        chat_id = c.message.chat.id
        rid_int = int(rid)

        if not require_finance(chat_id):
            return

        rec = get_record(chat_id, day_key, rid_int)
        if not rec:
            bot.answer_callback_query(c.id, "–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            return

        _pending_edit[chat_id] = (day_key, rid_int)
        bot.answer_callback_query(c.id)
        bot.send_message(
            chat_id,
            "‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏:\n"
            f"–°—Ç–∞—Ä–∞—è —Å—É–º–º–∞: {fmt_num(rec['amount'])}\n"
            f"–°—Ç–∞—Ä–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: {rec.get('note','')}\n\n"
            "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
            "+500 –û–±–µ–¥\n"
            "-200 –ú–∞–≥–∞–∑–∏–Ω",
        )
    except Exception as e:
        log_error(f"cb_edit_record: {e}")


# ==========================================================
# ========== –û–¢–°–ï–ö 15 ‚Äî –ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π ==========
# ==========================================================

MEDIA_TYPES = [
    "photo", "video", "document", "audio",
    "voice", "sticker", "animation"
]


@bot.message_handler(content_types=["text"])
def handle_text(msg: types.Message):
    """
    –ì–ª–∞–≤–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫:
    - –æ–±–Ω–æ–≤–ª—è–µ—Ç info-—á–∞—Ç–∞
    - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–µ—Å—ã–ª–∫—É
    - –∫–æ–º–∞–Ω–¥—ã /start, /–ø–æ–µ—Ö–∞–ª–∏
    - pending add/edit
    - –æ–±—ã—á–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    """
    update_chat_info_from_message(msg)
    chat_id = msg.chat.id
    text = (msg.text or "").strip()

    # 1) –í—Å–µ–≥–¥–∞ —Å–Ω–∞—á–∞–ª–∞ ‚Äî –ø–µ—Ä–µ—Å—ã–ª–∫–∞ (–∞–Ω–æ–Ω–∏–º–Ω–∞—è)
    try:
        forward_message_anonymous(msg)  # –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –¥–∞–ª–µ–µ
    except Exception as e:
        log_error(f"forward_message_anonymous(text): {e}")

    if not text:
        return

    # 2) –ö–æ–º–∞–Ω–¥—ã /start –∏ /–ø–æ–µ—Ö–∞–ª–∏
    if text.startswith("/start"):
        return cmd_start(msg)

    if text.startswith("/–ø–æ–µ—Ö–∞–ª–∏") or text.lower().startswith("/poehali") or text.lower().startswith("/go"):
        return cmd_poehali(msg)

    # 3) Pending-—Ä–µ–∂–∏–º—ã
    if chat_id in _pending_add:
        return handle_pending_add(msg)

    if chat_id in _pending_edit:
        return handle_pending_edit(msg)

    # 4) –î–∞–ª—å—à–µ ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ñ–∏–Ω. —Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω
    if not is_finance_mode(chat_id):
        return

    # 5) –ü–∞—Ä—Å–∏–º —Å—É–º–º—É –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
    tokens = text.split(maxsplit=1)
    if not tokens:
        return

    amount = parse_amount_token(tokens[0])
    if amount is None:
        return  # –Ω–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

    note = tokens[1] if len(tokens) > 1 else ""
    dk = today_key()

    add_record(chat_id, dk, amount, note)
    update_or_send_day_window(chat_id, dk)


@bot.message_handler(content_types=MEDIA_TYPES)
def handle_media(msg: types.Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–µ–¥–∏–∞:
    - –æ–±–Ω–æ–≤–ª—è–µ—Ç info-—á–∞—Ç–∞
    - –ø—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ—Å–ª–∞—Ç—å –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –ø–µ—Ä–µ—Å—ã–ª–∫–∏
    –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –º–µ–¥–∏–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è.
    """
    update_chat_info_from_message(msg)

    try:
        forward_message_anonymous(msg)  # –±—É–¥–µ—Ç –æ–ø–∏—Å–∞–Ω–∞ –≤ –±–ª–æ–∫–µ –ø–µ—Ä–µ—Å—ã–ª–∫–∏
    except Exception as e:
        log_error(f"forward_message_anonymous(media): {e}")
#5 /12‚¨ÜÔ∏è

# ==========================================================
# ========== –û–¢–°–ï–ö 16 ‚Äî –ö–æ–º–∞–Ω–¥—ã start / –ø–æ–µ—Ö–∞–ª–∏ ==========
# ==========================================================

@bot.message_handler(commands=["start"])
def cmd_start(msg: types.Message):
    update_chat_info_from_message(msg)
    chat_id = msg.chat.id

    bot.send_message(
        chat_id,
        "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã\n"
        "–≠—Ç–æ –º–Ω–æ–≥–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç.\n\n"
        "–ß—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –≤ —ç—Ç–æ–º —á–∞—Ç–µ ‚Äî –æ—Ç–ø—Ä–∞–≤—å—Ç–µ:\n"
        "/–ø–æ–µ—Ö–∞–ª–∏",
    )


@bot.message_handler(commands=["–ø–æ–µ—Ö–∞–ª–∏", "poehali", "go"])
def cmd_poehali(msg: types.Message):
    update_chat_info_from_message(msg)
    chat_id = msg.chat.id

    set_finance_mode(chat_id, True)

    dk = today_key()
    bot.send_message(
        chat_id,
        "üöÄ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω!\n"
        "–¢–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å—É–º–º—ã –≤–∏–¥–∞:\n"
        "+500 –û–±–µ–¥\n"
        "-200 –ú–∞–≥–∞–∑–∏–Ω\n\n"
        "–û—Ç–∫—Ä—ã–ª –æ–∫–Ω–æ –¥–Ω—è‚Ä¶"
    )

    update_or_send_day_window(chat_id, dk)


# ==========================================================
# ========== –û–¢–°–ï–ö 17 ‚Äî –ö–æ–º–∞–Ω–¥—ã /view /prev /next ==========
# ==========================================================

@bot.message_handler(commands=["view"])
def cmd_view(msg: types.Message):
    update_chat_info_from_message(msg)
    chat_id = msg.chat.id

    if not require_finance(chat_id):
        return

    parts = msg.text.strip().split(maxsplit=1)
    if len(parts) < 2:
        return bot.send_message(chat_id, "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /view YYYY-MM-DD")

    date_str = parts[1].strip()
    try:
        datetime.strptime(date_str, "%Y-%m-%d")
    except:
        return bot.send_message(chat_id, "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ü—Ä–∏–º–µ—Ä: /view 2025-01-20")

    update_or_send_day_window(chat_id, date_str)


@bot.message_handler(commands=["prev"])
def cmd_prev(msg: types.Message):
    update_chat_info_from_message(msg)
    chat_id = msg.chat.id

    if not require_finance(chat_id):
        return

    dk = today_key()
    try:
        day = datetime.strptime(dk, "%Y-%m-%d") - timedelta(days=1)
        update_or_send_day_window(chat_id, day.strftime("%Y-%m-%d"))
    except:
        pass


@bot.message_handler(commands=["next"])
def cmd_next(msg: types.Message):
    update_chat_info_from_message(msg)
    chat_id = msg.chat.id

    if not require_finance(chat_id):
        return

    dk = today_key()
    try:
        day = datetime.strptime(dk, "%Y-%m-%d") + timedelta(days=1)
        update_or_send_day_window(chat_id, day.strftime("%Y-%m-%d"))
    except:
        pass


# ==========================================================
# ========== –û–¢–°–ï–ö 18 ‚Äî Callback-–Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–Ω—è–º ==========
# ==========================================================

@bot.callback_query_handler(func=lambda c: c.data.startswith("d:"))
def cb_day_navigation(c: types.CallbackQuery):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥ –≤–∏–¥–∞ d:<day>:<cmd>.
    d:YYYY-MM-DD:open
    d:YYYY-MM-DD:prev
    d:YYYY-MM-DD:next
    d:YYYY-MM-DD:edit_list
    d:YYYY-MM-DD:calendar
    d:YYYY-MM-DD:report
    d:YYYY-MM-DD:info
    d:YYYY-MM-DD:total
    """
    try:
        _, day_key, cmd = c.data.split(":")
        chat_id = c.message.chat.id

        if cmd == "open":
            update_or_send_day_window(chat_id, day_key)
            return bot.answer_callback_query(c.id)

        if cmd == "prev":
            dk = datetime.strptime(day_key, "%Y-%m-%d") - timedelta(days=1)
            update_or_send_day_window(chat_id, dk.strftime("%Y-%m-%d"))
            return bot.answer_callback_query(c.id)

        if cmd == "next":
            dk = datetime.strptime(day_key, "%Y-%m-%d") + timedelta(days=1)
            update_or_send_day_window(chat_id, dk.strftime("%Y-%m-%d"))
            return bot.answer_callback_query(c.id)

        if cmd == "edit_list":
            open_edit_list(chat_id, day_key)
            return bot.answer_callback_query(c.id)

        if cmd == "calendar":
            center = datetime.strptime(day_key, "%Y-%m-%d")
            kb = build_calendar_keyboard(center, chat_id)
            bot.edit_message_text(
                f"üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å ‚Äî {day_key}",
                chat_id,
                c.message.message_id,
                reply_markup=kb
            )
            return bot.answer_callback_query(c.id)

        if cmd == "report":
            cmd_report(chat_id, day_key)
            return bot.answer_callback_query(c.id)

        if cmd == "info":
            cmd_info(chat_id, day_key)
            return bot.answer_callback_query(c.id)

        if cmd == "total":
            cmd_total(chat_id)
            return bot.answer_callback_query(c.id)

    except Exception as e:
        log_error(f"cb_day_navigation: {e}")
        bot.answer_callback_query(c.id, "–û—à–∏–±–∫–∞")


# ==========================================================
# ========== –û–¢–°–ï–ö ‚Äî –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–µ–≤ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è ==========
# ==========================================================

@bot.callback_query_handler(func=lambda c: c.data.startswith("c:"))
def cb_calendar_month(c: types.CallbackQuery):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ ¬´‚Äì31¬ª –∏ ¬´+31¬ª –¥–Ω–µ–π –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ.
    c:YYYY-MM-DD
    """
    try:
        center_day_str = c.data[2:]
        chat_id = c.message.chat.id

        center_day = datetime.strptime(center_day_str, "%Y-%m-%d")

        kb = build_calendar_keyboard(center_day, chat_id)

        bot.edit_message_text(
            f"üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å ‚Äî {center_day_str}",
            chat_id,
            c.message.message_id,
            reply_markup=kb
        )

        bot.answer_callback_query(c.id)
    except Exception as e:
        log_error(f"cb_calendar_month: {e}")
        bot.answer_callback_query(c.id, "–û—à–∏–±–∫–∞")
#üü¢6 /12‚¨ÜÔ∏è

# ==========================================================
# ========== –û–¢–°–ï–ö 19 ‚Äî –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ ¬´–ù–∞–∑–∞–¥¬ª ==========
# ==========================================================

@bot.callback_query_handler(func=lambda c: c.data.startswith("back:"))
def cb_back_handler(c: types.CallbackQuery):
    """
    back:day:YYYY-MM-DD      -> –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–∫–Ω—É –¥–Ω—è
    back:edit_list:YYYY-MM-DD -> –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    """
    try:
        parts = c.data.split(":", 2)
        if len(parts) < 2:
            return bot.answer_callback_query(c.id)

        _, target, rest = parts[0], parts[1], (parts[2] if len(parts) > 2 else "")
        chat_id = c.message.chat.id

        if target == "day" and rest:
            update_or_send_day_window(chat_id, rest)
            return bot.answer_callback_query(c.id)

        if target == "edit_list" and rest:
            open_edit_list(chat_id, rest)
            return bot.answer_callback_query(c.id)

        bot.answer_callback_query(c.id)
    except Exception as e:
        log_error(f"cb_back_handler: {e}")
        bot.answer_callback_query(c.id, "–û—à–∏–±–∫–∞")


# ==========================================================
# ========== –û–¢–°–ï–ö 20 ‚Äî –õ–æ–≥–∏–∫–∞ –ø—Ä–∞–≤–∏–ª –ø–µ—Ä–µ—Å—ã–ª–∫–∏ ==========
# ==========================================================

def resolve_forward_targets(chat_id: int) -> list[int]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–≤—ã—Ö —á–∞—Ç–æ–≤ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ chat_id.
    –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
        data["forward_rules"] = {
            "src_id": {
                "dst_id": "oneway" | "twoway",
                ...
            }
        }
    –î–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –Ω–∞–º –≤–∞–∂–µ–Ω —Ç–æ–ª—å–∫–æ —Å–∞–º —Ñ–∞–∫—Ç —Å–≤—è–∑–∏.
    """
    fr = data.get("forward_rules", {})
    src_rules = fr.get(str(chat_id), {})
    if not isinstance(src_rules, dict):
        return []
    targets = []
    for dst, mode in src_rules.items():
        try:
            dst_id = int(dst)
        except:
            continue
        if mode in ("oneway", "twoway"):
            targets.append(dst_id)
    return targets


def forward_message_anonymous(msg: types.Message):
    """
    –ê–Ω–æ–Ω–∏–º–Ω–∞—è –ø–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:
    - —Ç–µ–∫—Å—Ç
    - —Ñ–æ—Ç–æ
    - –≤–∏–¥–µ–æ
    - –¥–æ–∫—É–º–µ–Ω—Ç—ã
    - –∞—É–¥–∏–æ
    - –≥–æ–ª–æ—Å
    - —Å—Ç–∏–∫–µ—Ä—ã
    - –∞–Ω–∏–º–∞—Ü–∏—è

    –ë–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–º—ë–Ω –∏ username –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è.
    –°–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –∫–∞–∫ –æ—Ç –±–æ—Ç–∞.
    """
    cid = msg.chat.id
    targets = resolve_forward_targets(cid)
    if not targets:
        return

    content_type = msg.content_type

    for dst in targets:
        try:
            if content_type == "text":
                bot.send_message(dst, msg.text or "")

            elif content_type == "photo":
                bot.send_photo(dst, msg.photo[-1].file_id, caption=msg.caption or "")

            elif content_type == "video":
                bot.send_video(dst, msg.video.file_id, caption=msg.caption or "")

            elif content_type == "document":
                bot.send_document(dst, msg.document.file_id, caption=getattr(msg, "caption", "") or "")

            elif content_type == "audio":
                bot.send_audio(dst, msg.audio.file_id, caption=getattr(msg, "caption", "") or "")

            elif content_type == "voice":
                bot.send_voice(dst, msg.voice.file_id)

            elif content_type == "sticker":
                bot.send_sticker(dst, msg.sticker.file_id)

            elif content_type == "animation":
                bot.send_animation(dst, msg.animation.file_id, caption=getattr(msg, "caption", "") or "")

            else:
                # –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π ‚Äî —Ç–µ–∫—Å—Ç–æ–≤–∞—è –∑–∞–≥–ª—É—à–∫–∞
                bot.send_message(dst, "‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–≥–æ —Ç–∏–ø–∞.")

        except Exception as e:
            log_error(f"forward_message_anonymous to {dst}: {e}")


# ==========================================================
# ========== –û–¢–°–ï–ö 21 ‚Äî –ú–µ–Ω—é –ø–µ—Ä–µ—Å—ã–ª–∫–∏ (/forward) ==========
# ==========================================================

def open_forward_main(chat_id: int):
    """
    –ë–∞–∑–æ–≤–æ–µ –º–µ–Ω—é –ø–µ—Ä–µ—Å—ã–ª–∫–∏:
    –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —á–∞—Ç–æ–≤.
    –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ OWNER'—É.
    """
    if not OWNER_ID or str(chat_id) != str(OWNER_ID):
        return

    kc = data.get("known_chats", {})
    if not kc:
        bot.send_message(chat_id, "–ù–µ—Ç –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —á–∞—Ç–æ–≤.")
        return

    kb = types.InlineKeyboardMarkup(row_width=1)

    for cid, meta in kc.items():
        title = meta.get("title") or meta.get("username") or f"–ß–∞—Ç {cid}"
        kb.add(
            types.InlineKeyboardButton(
                f"üîÅ {title}",
                callback_data=f"fw_open:{cid}"
            )
        )

    kb.add(
        types.InlineKeyboardButton(
            "üîô –ó–∞–∫—Ä—ã—Ç—å",
            callback_data="fw_back_main"
        )
    )

    bot.send_message(chat_id, "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç-–∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ—Å—ã–ª–∫–∏:", reply_markup=kb)


@bot.message_handler(commands=["forward"])
def cmd_forward(msg: types.Message):
    """
    –ö–æ–º–∞–Ω–¥–∞ /forward (—Ç–æ–ª—å–∫–æ –¥–ª—è OWNER).
    –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø–µ—Ä–µ—Å—ã–ª–∫–∏.
    """
    return open_forward_main(msg.chat.id)


@bot.callback_query_handler(func=lambda c: c.data.startswith("fw_open:"))
def cb_fw_open(c: types.CallbackQuery):
    """
    –û—Ç–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —á–∞—Ç–∞.
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —á–∞—Ç—ã –∏ —Ä–µ–∂–∏–º—ã ‚û°Ô∏è ‚áÑ ‚¨ÖÔ∏è —Å –≥–∞–ª–æ—á–∫–∞–º–∏.
    """
    try:
        chat_id = c.message.chat.id
        if not OWNER_ID or str(chat_id) != str(OWNER_ID):
            return

        _, src = c.data.split(":", 1)
        src = str(src)

        kc = data.get("known_chats", {})
        fr = data.get("forward_rules", {})

        kb = types.InlineKeyboardMarkup(row_width=3)

        for dst, meta in kc.items():
            if dst == src:
                continue

            dst_title = meta.get("title") or meta.get("username") or f"chat {dst}"

            src_rules = fr.get(src, {})
            dst_rules = fr.get(dst, {})

            mode_forward = src_rules.get(dst)          # src -> dst
            mode_reverse = dst_rules.get(src)          # dst -> src

            mark_forward = "‚úÖ" if mode_forward == "oneway" else ""
            mark_reverse = "‚úÖ" if mode_reverse == "oneway" else ""
            mark_both = "‚úÖ" if (mode_forward == "twoway" or mode_reverse == "twoway") else ""

            kb.row(
                types.InlineKeyboardButton(
                    f"{mark_forward} ‚û°Ô∏è",
                    callback_data=f"fw_set:{src}:{dst}:oneway"
                ),
                types.InlineKeyboardButton(
                    f"{mark_both} ‚áÑ",
                    callback_data=f"fw_set_tw:{src}:{dst}:twoway"
                ),
                types.InlineKeyboardButton(
                    f"{mark_reverse} ‚¨ÖÔ∏è",
                    callback_data=f"fw_set_rev:{src}:{dst}:oneway"
                ),
            )
            kb.add(
                types.InlineKeyboardButton(
                    dst_title,
                    callback_data="fw_nop"
                )
            )

        kb.add(
            types.InlineKeyboardButton(
                "üîô –ù–∞–∑–∞–¥",
                callback_data="fw_back"
            )
        )

        bot.answer_callback_query(c.id)
        bot.edit_message_text(
            f"–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –¥–ª—è —á–∞—Ç–∞ {src}:",
            chat_id,
            c.message.message_id,
            reply_markup=kb
        )
    except Exception as e:
        log_error(f"cb_fw_open: {e}")
        bot.answer_callback_query(c.id, "–û—à–∏–±–∫–∞")


@bot.callback_query_handler(func=lambda c: c.data.startswith("fw_set:"))
def cb_fw_set_oneway(c: types.CallbackQuery):
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–≤—è–∑—å src -> dst (–æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—è—è ‚û°Ô∏è).
    """
    try:
        _, src, dst, _mode = c.data.split(":")
        fr = data.setdefault("forward_rules", {})
        fr_src = fr.setdefault(src, {})
        fr_src[dst] = "oneway"

        save_data()
        bot.answer_callback_query(c.id, "–ì–æ—Ç–æ–≤–æ")
        open_forward_main(c.message.chat.id)
    except Exception as e:
        log_error(f"cb_fw_set_oneway: {e}")
        bot.answer_callback_query(c.id, "–û—à–∏–±–∫–∞")


@bot.callback_query_handler(func=lambda c: c.data.startswith("fw_set_rev:"))
def cb_fw_set_reverse(c: types.CallbackQuery):
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å dst -> src (–æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—è—è ‚¨ÖÔ∏è).
    """
    try:
        _, src, dst, _mode = c.data.split(":")
        fr = data.setdefault("forward_rules", {})
        fr_dst = fr.setdefault(dst, {})
        fr_dst[src] = "oneway"

        save_data()
        bot.answer_callback_query(c.id, "–ì–æ—Ç–æ–≤–æ")
        open_forward_main(c.message.chat.id)
    except Exception as e:
        log_error(f"cb_fw_set_reverse: {e}")
        bot.answer_callback_query(c.id, "–û—à–∏–±–∫–∞")


@bot.callback_query_handler(func=lambda c: c.data.startswith("fw_set_tw:"))
def cb_fw_set_twoway(c: types.CallbackQuery):
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—é—é —Å–≤—è–∑—å src ‚áÑ dst.
    """
    try:
        _, src, dst, _mode = c.data.split(":")
        fr = data.setdefault("forward_rules", {})

        fr_src = fr.setdefault(src, {})
        fr_dst = fr.setdefault(dst, {})

        fr_src[dst] = "twoway"
        fr_dst[src] = "twoway"

        save_data()
        bot.answer_callback_query(c.id, "–ì–æ—Ç–æ–≤–æ")
        open_forward_main(c.message.chat.id)
    except Exception as e:
        log_error(f"cb_fw_set_twoway: {e}")
        bot.answer_callback_query(c.id, "–û—à–∏–±–∫–∞")


@bot.callback_query_handler(func=lambda c: c.data == "fw_back")
def cb_fw_back(c: types.CallbackQuery):
    """
    –ö–Ω–æ–ø–∫–∞ ¬´–ù–∞–∑–∞–¥¬ª –∏–∑ –ø–æ–¥–º–µ–Ω—é –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é –ø–µ—Ä–µ—Å—ã–ª–∫–∏.
    """
    bot.answer_callback_query(c.id)
    open_forward_main(c.message.chat.id)


@bot.callback_query_handler(func=lambda c: c.data == "fw_back_main")
def cb_fw_back_main(c: types.CallbackQuery):
    """
    –ö–Ω–æ–ø–∫–∞ ¬´–ó–∞–∫—Ä—ã—Ç—å¬ª –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é –ø–µ—Ä–µ—Å—ã–ª–∫–∏.
    –ü—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ—Ç —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ.
    """
    try:
        bot.answer_callback_query(c.id)
        bot.delete_message(c.message.chat.id, c.message.message_id)
    except Exception as e:
        log_error(f"cb_fw_back_main: {e}")


@bot.callback_query_handler(func=lambda c: c.data == "fw_nop")
def cb_fw_nop(c: types.CallbackQuery):
    """
    –ó–∞–≥–ª—É—à–∫–∞ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç, –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–ø–ª—ã–≤–∞—à–∫—É.
    """
    bot.answer_callback_query(c.id)


@bot.message_handler(commands=["stopforward"])
def cmd_stopforward(msg: types.Message):
    """
    –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã forward_rules (—Ç–æ–ª—å–∫–æ OWNER).
    """
    if not OWNER_ID or str(msg.chat.id) != str(OWNER_ID):
        return

    data["forward_rules"] = {}
    save_data()
    bot.send_message(msg.chat.id, "üîÅ –í—Å–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –æ—á–∏—â–µ–Ω—ã.")
#üü¢7/12‚¨ÜÔ∏è

# ==========================================================
# ========== –û–¢–°–ï–ö 22 ‚Äî CSV / JSON —ç–∫—Å–ø–æ—Ä—Ç ==========
# ==========================================================

@bot.message_handler(commands=["csv"])
def cmd_csv(msg: types.Message):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç CSV-—Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞.
    """
    update_chat_info_from_message(msg)
    chat_id = msg.chat.id

    if not require_finance(chat_id):
        return

    cid = str(chat_id)
    csv_path = f"data_{cid}.csv"

    if not os.path.exists(csv_path):
        bot.send_message(chat_id, "CSV –ø–æ–∫–∞ –Ω–µ—Ç ‚Äî –¥–∞–Ω–Ω—ã—Ö –µ—â—ë –Ω–µ –±—ã–ª–æ.")
        return

    try:
        with open(csv_path, "rb") as f:
            bot.send_document(chat_id, f, visible_file_name=f"data_{cid}.csv")
    except Exception as e:
        log_error(f"cmd_csv error: {e}")
        bot.send_message(chat_id, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ CSV.")


@bot.message_handler(commands=["json"])
def cmd_json(msg: types.Message):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç JSON-—Ñ–∞–π–ª data_<chat_id>.json.
    """
    update_chat_info_from_message(msg)
    chat_id = msg.chat.id

    if not require_finance(chat_id):
        return

    cid = str(chat_id)
    json_path = f"data_{cid}.json"

    if not os.path.exists(json_path):
        bot.send_message(chat_id, "JSON –ø–æ–∫–∞ –Ω–µ—Ç ‚Äî –¥–∞–Ω–Ω—ã—Ö –µ—â—ë –Ω–µ –±—ã–ª–æ.")
        return

    try:
        with open(json_path, "rb") as f:
            bot.send_document(chat_id, f, visible_file_name=f"data_{cid}.json")
    except Exception as e:
        log_error(f"cmd_json error: {e}")
        bot.send_message(chat_id, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ JSON.")


@bot.message_handler(commands=["csv_all"])
def cmd_csv_all(msg: types.Message):
    """
    –ö–æ–º–∞–Ω–¥–∞ /csv_all ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –í–°–ï CSV-—Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å.
    –¢–æ–ª—å–∫–æ OWNER.
    """
    update_chat_info_from_message(msg)
    chat_id = msg.chat.id

    if not OWNER_ID or str(chat_id) != str(OWNER_ID):
        bot.send_message(chat_id, "–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ OWNER.")
        return

    files = [f for f in os.listdir(".") if f.startswith("data_") and f.endswith(".csv")]

    if not files:
        bot.send_message(chat_id, "–ù–µ—Ç CSV-—Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.")
        return

    for fn in files:
        try:
            with open(fn, "rb") as f:
                bot.send_document(chat_id, f, visible_file_name=fn)
        except Exception as e:
            log_error(f"cmd_csv_all send {fn}: {e}")


# ==========================================================
# ========== –û–¢–°–ï–ö 23 ‚Äî –ö–æ–º–∞–Ω–¥–∞ /help ==========
# ==========================================================

@bot.message_handler(commands=["help"])
def cmd_help(msg: types.Message):
    """
    –ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ —Ñ—É–Ω–∫—Ü–∏—è–º.
    """
    update_chat_info_from_message(msg)
    chat_id = msg.chat.id

    text = (
        "<b>–ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É</b>\n\n"
        "–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/start ‚Äî –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞\n"
        "/–ø–æ–µ—Ö–∞–ª–∏ ‚Äî –≤–∫–ª—é—á–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º\n"
        "/view YYYY-MM-DD ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å\n"
        "/prev /next ‚Äî –≤—á–µ—Ä–∞ / –∑–∞–≤—Ç—Ä–∞\n"
        "/report ‚Äî –æ—Ç—á—ë—Ç –ø–æ –¥–Ω—é\n"
        "/balance ‚Äî –±–∞–ª–∞–Ω—Å –ø–æ —á–∞—Ç—É\n"
        "/csv ‚Äî –≤—ã–≥—Ä—É–∑–∫–∞ CSV —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞\n"
        "/json ‚Äî –≤—ã–≥—Ä—É–∑–∫–∞ JSON —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞\n"
        "/forward ‚Äî –º–µ–Ω—é –ø–µ—Ä–µ—Å—ã–ª–∫–∏ (—Ç–æ–ª—å–∫–æ OWNER)\n"
        "/help ‚Äî —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
    )

    bot.send_message(chat_id, text, parse_mode="HTML")


# ==========================================================
# ========== –û–¢–°–ï–ö 24 ‚Äî –°–ª—É–∂–µ–±–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã ID/PING/VERSION ==========
# ==========================================================

@bot.message_handler(commands=["id"])
def cmd_id(msg: types.Message):
    update_chat_info_from_message(msg)
    bot.send_message(msg.chat.id, f"–í–∞—à ID: <code>{msg.from_user.id}</code>\nChat ID: <code>{msg.chat.id}</code>", parse_mode="HTML")


@bot.message_handler(commands=["ping"])
def cmd_ping(msg: types.Message):
    update_chat_info_from_message(msg)
    bot.send_message(msg.chat.id, "pong")


@bot.message_handler(commands=["version"])
def cmd_version(msg: types.Message):
    update_chat_info_from_message(msg)
    bot.send_message(msg.chat.id, f"–í–µ—Ä—Å–∏—è –±–æ—Ç–∞: <b>{VERSION}</b>", parse_mode="HTML")
#üî¥8/12‚¨ÜÔ∏è

# ==========================================================
# ========== –û–¢–°–ï–ö 25 ‚Äî Keep-Alive (–ø–∏–Ω–≥ —Ä–∞–∑ –≤ 60 —Å–µ–∫) ==========
# ==========================================================

def keep_alive_loop():
    """
    –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —à–ª—ë—Ç 'keep-alive' –∑–∞–ø—Ä–æ—Å,
    —á—Ç–æ–±—ã Render / PythonAnywhere –Ω–µ ¬´—É—Å—ã–ø–ª—è–ª¬ª –ø—Ä–æ—Ü–µ—Å—Å.
    """
    while True:
        try:
            time.sleep(60)
            log_info("keep-alive ping")
        except Exception as e:
            log_error(f"keep_alive_loop: {e}")


ka_thread = threading.Thread(target=keep_alive_loop, daemon=True)
ka_thread.start()


# ==========================================================
# ========== –û–¢–°–ï–ö 26 ‚Äî –ê–≤—Ç–æ-–±—ç–∫–∞–ø (–≤ BACKUP_CHAT_ID) ==========
# ==========================================================

def send_backup_files():
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ JSON –∏ CSV –≤ BACKUP_CHAT_ID.
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ watchdog'–æ–º.
    """
    if not BACKUP_CHAT_ID:
        return

    # JSON/CSV only
    files = [
        f for f in os.listdir(".")
        if f.startswith("data_") and (f.endswith(".json") or f.endswith(".csv"))
    ]

    for fn in files:
        try:
            with open(fn, "rb") as f:
                bot.send_document(int(BACKUP_CHAT_ID), f, visible_file_name=fn)
                time.sleep(0.2)
        except Exception as e:
            log_error(f"send_backup_files: {e}")


# ==========================================================
# ========== –û–¢–°–ï–ö 27 ‚Äî Watchdog + –∞–Ω—Ç–∏-–¥—É–±–ª–∏–∫–∞—Ç–æ—Ä ==========
# ==========================================================

_last_forward_hash: dict[str, float] = {}


def is_duplicate_forward(chat_id: int, content_type: str, payload: str) -> bool:
    """
    –ü—Ä–æ—Å—Ç–µ–π—à–∞—è –∞–Ω—Ç–∏-–¥—É–±–ª–∏–∫–∞—Ç–æ—Ä–Ω–∞—è –∑–∞—â–∏—Ç–∞ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏.
    content_type + payload ‚Üí —Ö–µ—à–∏—Ä—É–µ–º.
    –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ö–µ—à –Ω–∞ 2‚Äì3 —Å–µ–∫—É–Ω–¥—ã.
    """
    key = f"{chat_id}:{content_type}:{payload}"
    now = time.time()

    # –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∏ –ø—Ä–æ—à–ª–æ < 3 —Å–µ–∫—É–Ω–¥ ‚Äî –¥—É–±–ª–∏–∫–∞—Ç
    if key in _last_forward_hash and (now - _last_forward_hash[key] < 3):
        return True

    _last_forward_hash[key] = now
    return False


def watchdog_loop():
    """
    –ö–∞–∂–¥—ã–µ 120 —Å–µ–∫—É–Ω–¥:
    - —á–∏—Å—Ç–∏—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∞–Ω—Ç–∏-–¥—É–±–ª–∏–∫–∞—Ç—ã
    - –¥–µ–ª–∞–µ—Ç –±—ç–∫–∞–ø
    """
    while True:
        try:
            time.sleep(120)

            # –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ö–µ—à–∏
            now = time.time()
            to_del = []
            for k, ts in _last_forward_hash.items():
                if now - ts > 10:  # —Å—Ç–∞—Ä—à–µ 10 —Å–µ–∫ ‚Üí —É–¥–∞–ª–∏—Ç—å
                    to_del.append(k)
            for k in to_del:
                del _last_forward_hash[k]

            # –¥–µ–ª–∞–µ–º –±—ç–∫–∞–ø
            send_backup_files()

            log_info("watchdog OK")

        except Exception as e:
            log_error(f"watchdog_loop: {e}")


wd_thread = threading.Thread(target=watchdog_loop, daemon=True)
wd_thread.start()
#üîµ9/12‚¨ÜÔ∏è

# ==========================================================
# ========== –û–¢–°–ï–ö 28 ‚Äî Flask Webhook Endpoint ==========
# ==========================================================

@app.route(f"/webhook", methods=["POST"])
def webhook_handler():
    """
    –ü—Ä–∏—ë–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω WEBHOOK).
    """
    try:
        raw = request.data.decode("utf-8")
        update = telebot.types.Update.de_json(raw)
        bot.process_new_updates([update])
    except Exception as e:
        log_error(f"webhook_handler: {e}")
    return "OK", 200


@app.route("/", methods=["GET"])
def root_handler():
    """
    –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∂–∏–≤.
    """
    return f"Bot {VERSION} is running", 200


# ==========================================================
# ========== –û–¢–°–ï–ö 29 ‚Äî –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ–±—Ö—É–∫–∞ ==========
# ==========================================================

def setup_webhook():
    if not USE_WEBHOOK:
        log_info("WEBHOOK –æ—Ç–∫–ª—é—á—ë–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º long-polling.")
        return

    if not WEBHOOK_URL:
        log_error("WEBHOOK_URL –ø—É—Å—Ç ‚Äî –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–µ–±—Ö—É–∫.")
        return

    try:
        bot.remove_webhook()
        time.sleep(1)
        bot.set_webhook(
            url=WEBHOOK_URL,
            allowed_updates=[
                "message",
                "callback_query",
            ],
            drop_pending_updates=True,
        )
        log_info(f"Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {WEBHOOK_URL}")
    except Exception as e:
        log_error(f"setup_webhook error: {e}")


# ==========================================================
# ========== –û–¢–°–ï–ö 30 ‚Äî –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ ==========
# ==========================================================

def run_long_polling():
    """
    –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ long-polling (–µ—Å–ª–∏ USE_WEBHOOK = 0).
    –ü–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º —É–¥–∞–ª—è–µ–º webhook, —á—Ç–æ–±—ã –Ω–µ –ª–æ–≤–∏—Ç—å 409:
    "can't use getUpdates method while webhook is active".
    """
    log_info("–ó–∞–ø—É—Å–∫ long-polling...")

    # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —Å–Ω–∏–º–∞–µ–º webhook –ø–µ—Ä–µ–¥ long-polling
    try:
        bot.remove_webhook(drop_pending_updates=True)
        log_info("Webhook —É–¥–∞–ª—ë–Ω –ø–µ—Ä–µ–¥ long-polling")
    except Exception as e:
        log_error(f"remove_webhook before polling: {e}")

    while True:
        try:
            bot.infinity_polling(
                allowed_updates=[
                    "message",
                    "callback_query",
                ],
                timeout=30,
                long_polling_timeout=30,
            )
        except Exception as e:
            log_error(f"polling error: {e}")
            time.sleep(3)
if __name__ == "__main__":
    log_info(f"üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ {VERSION} ‚Ä¶")
    load_data()     # –∑–∞–≥—Ä—É–∑–∏–ª–∏ data.json
    setup_webhook()

    if USE_WEBHOOK:
        # Webhook mode
        log_info("–†–µ–∂–∏–º: WEBHOOK")
        app.run(
            host="0.0.0.0",
            port=PORT,
            debug=False,
            use_reloader=False,
        )
    else:
        # Long-polling fallback
        log_info("–†–µ–∂–∏–º: LONG-POLLING")
        run_long_polling()
#üü§10/12‚¨ÜÔ∏è

#üü†11/12‚¨ÜÔ∏è
#üü£12/12‚¨ÜÔ∏è